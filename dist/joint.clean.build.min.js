/*! JointJS v0.9.3 - JavaScript diagramming library  2015-07-23 


This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
!function(a,b){if("function"==typeof define&&define.amd)define(["backbone","lodash","jquery","g","V"],function(c,d,e,f,g){return c.$=e,b(a,c,d,e,f,g)});else if("undefined"!=typeof exports){var c=require("backbone"),d=require("lodash"),e=c.$=require("jquery"),f=require("./geometry"),g=require("./vectorizer");module.exports=b(a,c,d,e,f,g)}else{var c=a.Backbone,d=a._,e=c.$=a.jQuery||a.$,f=a.g,g=a.V;a.joint=b(a,c,d,e,f,g)}}(this,function(a,b,c,d,e,f){var g={version:"0.9.3",dia:{},ui:{},layout:{},shapes:{},format:{},connectors:{},routers:{},util:{hashCode:function(a){var b=0;if(0==a.length)return b;for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);b=(b<<5)-b+d,b&=b}return b},getByPath:function(a,b,c){c=c||"/";for(var d,e=b.split(c);e.length;){if(d=e.shift(),!(Object(a)===a&&d in a))return void 0;a=a[d]}return a},setByPath:function(a,b,c,d){d=d||"/";var e=b.split(d),f=a,g=0;if(b.indexOf(d)>-1){for(var h=e.length;h-1>g;g++)f=f[e[g]]||(f[e[g]]={});f[e[h-1]]=c}else a[b]=c;return a},unsetByPath:function(a,b,c){c=c||"/";var d=b.lastIndexOf(c);if(d>-1){var e=g.util.getByPath(a,b.substr(0,d),c);e&&delete e[b.slice(d+1)]}else delete a[b];return a},flattenObject:function(a,b,c){b=b||"/";var d={};for(var e in a)if(a.hasOwnProperty(e)){var f="object"==typeof a[e];if(f&&c&&c(a[e])&&(f=!1),f){var g=this.flattenObject(a[e],b,c);for(var h in g)g.hasOwnProperty(h)&&(d[e+b+h]=g[h])}else d[e]=a[e]}return d},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},guid:function(a){return this.guid.id=this.guid.id||1,a.id=void 0===a.id?"j_"+this.guid.id++:a.id,a.id},mixin:function(){for(var a=arguments[0],b=1,d=arguments.length;d>b;b++){var e=arguments[b];(Object(e)===e||c.isFunction(e)||null!==e&&void 0!==e)&&c.each(e,function(b,d){return this.mixin.deep&&Object(b)===b?(a[d]||(a[d]=c.isArray(b)?[]:{}),void this.mixin(a[d],b)):void(a[d]!==b&&(this.mixin.supplement&&a.hasOwnProperty(d)||(a[d]=b)))},this)}return a},supplement:function(){this.mixin.supplement=!0;var a=this.mixin.apply(this,arguments);return this.mixin.supplement=!1,a},deepMixin:function(){this.mixin.deep=!0;var a=this.mixin.apply(this,arguments);return this.mixin.deep=!1,a},deepSupplement:function(){this.mixin.deep=this.mixin.supplement=!0;var a=this.mixin.apply(this,arguments);return this.mixin.deep=this.mixin.supplement=!1,a},normalizeEvent:function(a){return a.originalEvent&&a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length?a.originalEvent.changedTouches[0]:a},nextFrame:function(){var a,b="undefined"!=typeof window;if(b&&(a=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame),!a){var d=0;a=function(a){var b=(new Date).getTime(),c=Math.max(0,16-(b-d)),e=setTimeout(function(){a(b+c)},c);return d=b+c,e}}return b?c.bind(a,window):a}(),cancelFrame:function(){var a,b="undefined"!=typeof window;return b&&(a=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||window.oCancelAnimationFrame||window.oCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame),a=a||clearTimeout,b?c.bind(a,window):a}(),shapePerimeterConnectionPoint:function(a,b,c,d){var g,h;if(!c){var i=b.$(".scalable")[0],j=b.$(".rotatable")[0];i&&i.firstChild?c=i.firstChild:j&&j.firstChild&&(c=j.firstChild)}return c?(h=f(c).findIntersection(d,a.paper.viewport),h||(g=e.rect(f(c).bbox(!1,a.paper.viewport)))):(g=b.model.getBBox(),h=g.intersectionWithLineFromCenterToPoint(d)),h||g.center()},breakText:function(a,b,c,d){d=d||{};var e=b.width,g=b.height,h=d.svgDocument||f("svg").node,i=f("<text><tspan></tspan></text>").attr(c||{}).node,j=i.firstChild,k=document.createTextNode("");j.appendChild(k),h.appendChild(i),d.svgDocument||document.body.appendChild(h);for(var l,m=a.split(" "),n=[],o=[],p=0,q=0,r=m.length;r>p;p++){var s=m[p];if(k.data=o[q]?o[q]+" "+s:s,j.getComputedTextLength()<=e)o[q]=k.data,l&&(n[q++]=!0,l=0);else{if(!o[q]||l){var t=!!l;if(l=s.length-1,t||!l){if(!l){if(!o[q]){o=[];break}m.splice(p,2,s+m[p+1]),r--,n[q++]=!0,p--;continue}m[p]=s.substring(0,l),m[p+1]=s.substring(l)+m[p+1]}else m.splice(p,1,s.substring(0,l),s.substring(l)),r++,q&&!n[q-1]&&q--;p--;continue}q++,p--}if("undefined"!=typeof g){var u=u||1.25*i.getBBox().height;if(u*o.length>g){o.splice(Math.floor(g/u));break}}}return d.svgDocument?h.removeChild(i):document.body.removeChild(h),o.join("\n")},imageToDataUri:function(a,b){if(!a||"data:"===a.substr(0,"data:".length))return setTimeout(function(){b(null,a)},0);var c=document.createElement("canvas"),d=document.createElement("img");d.onload=function(){var e=c.getContext("2d");c.width=d.width,c.height=d.height,e.drawImage(d,0,0);try{var f=(a.split(".").pop()||"png","jpeg"),g=c.toDataURL(f)}catch(h){if(/\.svg$/.test(a)){var i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");i.open("GET",a,!1),i.send(null);var j=i.responseText;return b(null,"data:image/svg+xml,"+encodeURIComponent(j))}console.error(d.src,"fails to convert",h)}b(null,g)},d.ononerror=function(){b(new Error("Failed to load image."))},d.src=a},getElementBBox:function(a){var b,c=d(a),e=c.offset();if(a.ownerSVGElement){b=f(a).bbox();var g=a.getBoundingClientRect(),h=(g.width-b.width)/2,i=(g.height-b.height)/2;b.x=e.left+h,b.y=e.top+i}else b={x:e.left,y:e.top,width:c.outerWidth(),height:c.outerHeight()};return b},sortElements:function(a,b){var c=d(a),e=c.map(function(){var a=this,b=a.parentNode,c=b.insertBefore(document.createTextNode(""),a.nextSibling);return function(){if(b===this)throw new Error("You can't sort elements if any one is a descendant of another.");b.insertBefore(this,c),b.removeChild(c)}});return Array.prototype.sort.call(c,b).each(function(a){e[a].call(this)})},normalizeSides:function(a){return Object(a)!==a?(a=a||0,{top:a,bottom:a,left:a,right:a}):{top:a.top||0,bottom:a.bottom||0,left:a.left||0,right:a.right||0}},timing:{linear:function(a){return a},quad:function(a){return a*a},cubic:function(a){return a*a*a},inout:function(a){if(0>=a)return 0;if(a>=1)return 1;var b=a*a,c=b*a;return 4*(.5>a?c:3*(a-b)+c-.75)},exponential:function(a){return Math.pow(2,10*(a-1))},bounce:function(a){for(var b=0,c=1;1;b+=c,c/=2)if(a>=(7-4*b)/11){var d=(11-6*b-11*a)/4;return-d*d+c*c}},reverse:function(a){return function(b){return 1-a(1-b)}},reflect:function(a){return function(b){return.5*(.5>b?a(2*b):2-a(2-2*b))}},clamp:function(a,b,c){return b=b||0,c=c||1,function(d){var e=a(d);return b>e?b:e>c?c:e}},back:function(a){return a||(a=1.70158),function(b){return b*b*((a+1)*b-a)}},elastic:function(a){return a||(a=1.5),function(b){return Math.pow(2,10*(b-1))*Math.cos(20*Math.PI*a/3*b)}}},interpolate:{number:function(a,b){var c=b-a;return function(b){return a+c*b}},object:function(a,b){var d=c.keys(a);return function(c){var e,f,g={};for(e=d.length-1;-1!=e;e--)f=d[e],g[f]=a[f]+(b[f]-a[f])*c;return g}},hexColor:function(a,b){var c=parseInt(a.slice(1),16),d=parseInt(b.slice(1),16),e=255&c,f=(255&d)-e,g=65280&c,h=(65280&d)-g,i=16711680&c,j=(16711680&d)-i;return function(a){var b=e+f*a&255,c=g+h*a&65280,d=i+j*a&16711680;return"#"+(1<<24|b|c|d).toString(16).slice(1)}},unit:function(a,b){var c=/(-?[0-9]*.[0-9]*)(px|em|cm|mm|in|pt|pc|%)/,d=c.exec(a),e=c.exec(b),f=e[1].indexOf("."),g=f>0?e[1].length-f-1:0;a=+d[1];var h=+e[1]-a,i=d[2];return function(b){return(a+h*b).toFixed(g)+i}}},filter:{outline:function(a){var b='<filter><feFlood flood-color="${color}" flood-opacity="${opacity}" result="colored"/><feMorphology in="SourceAlpha" result="morphedOuter" operator="dilate" radius="${outerRadius}" /><feMorphology in="SourceAlpha" result="morphedInner" operator="dilate" radius="${innerRadius}" /><feComposite result="morphedOuterColored" in="colored" in2="morphedOuter" operator="in"/><feComposite operator="xor" in="morphedOuterColored" in2="morphedInner" result="outline"/><feMerge><feMergeNode in="outline"/><feMergeNode in="SourceGraphic"/></feMerge></filter>',d=c.isFinite(a.margin)?a.margin:2,e=c.isFinite(a.width)?a.width:1;return c.template(b,{color:a.color||"blue",opacity:c.isFinite(a.opacity)?a.opacity:1,outerRadius:d+e,innerRadius:d})},highlight:function(a){var b='<filter><feFlood flood-color="${color}" flood-opacity="${opacity}" result="colored"/><feMorphology result="morphed" in="SourceGraphic" operator="dilate" radius="${width}"/><feComposite result="composed" in="colored" in2="morphed" operator="in"/><feGaussianBlur result="blured" in="composed" stdDeviation="${blur}"/><feBlend in="SourceGraphic" in2="blured" mode="normal"/></filter>';return c.template(b,{color:a.color||"red",width:c.isFinite(a.width)?a.width:1,blur:c.isFinite(a.blur)?a.blur:0,opacity:c.isFinite(a.opacity)?a.opacity:1})},blur:function(a){var b=c.isFinite(a.x)?a.x:2;return c.template('<filter><feGaussianBlur stdDeviation="${stdDeviation}"/></filter>',{stdDeviation:c.isFinite(a.y)?[b,a.y]:b})},dropShadow:function(a){var b="SVGFEDropShadowElement"in window?'<filter><feDropShadow stdDeviation="${blur}" dx="${dx}" dy="${dy}" flood-color="${color}" flood-opacity="${opacity}"/></filter>':'<filter><feGaussianBlur in="SourceAlpha" stdDeviation="${blur}"/><feOffset dx="${dx}" dy="${dy}" result="offsetblur"/><feFlood flood-color="${color}"/><feComposite in2="offsetblur" operator="in"/><feComponentTransfer><feFuncA type="linear" slope="${opacity}"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter>';return c.template(b,{dx:a.dx||0,dy:a.dy||0,opacity:c.isFinite(a.opacity)?a.opacity:1,color:a.color||"black",blur:c.isFinite(a.blur)?a.blur:4})},grayscale:function(a){var b=c.isFinite(a.amount)?a.amount:1;return c.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${b} ${h} 0 0 0 0 0 1 0"/></filter>',{a:.2126+.7874*(1-b),b:.7152-.7152*(1-b),c:.0722-.0722*(1-b),d:.2126-.2126*(1-b),e:.7152+.2848*(1-b),f:.0722-.0722*(1-b),g:.2126-.2126*(1-b),h:.0722+.9278*(1-b)})},sepia:function(a){var b=c.isFinite(a.amount)?a.amount:1;return c.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${h} ${i} 0 0 0 0 0 1 0"/></filter>',{a:.393+.607*(1-b),b:.769-.769*(1-b),c:.189-.189*(1-b),d:.349-.349*(1-b),e:.686+.314*(1-b),f:.168-.168*(1-b),g:.272-.272*(1-b),h:.534-.534*(1-b),i:.131+.869*(1-b)})},saturate:function(a){var b=c.isFinite(a.amount)?a.amount:1;return c.template('<filter><feColorMatrix type="saturate" values="${amount}"/></filter>',{amount:1-b})},hueRotate:function(a){return c.template('<filter><feColorMatrix type="hueRotate" values="${angle}"/></filter>',{angle:a.angle||0})},invert:function(a){var b=c.isFinite(a.amount)?a.amount:1;return c.template('<filter><feComponentTransfer><feFuncR type="table" tableValues="${amount} ${amount2}"/><feFuncG type="table" tableValues="${amount} ${amount2}"/><feFuncB type="table" tableValues="${amount} ${amount2}"/></feComponentTransfer></filter>',{amount:b,amount2:1-b})},brightness:function(a){return c.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}"/><feFuncG type="linear" slope="${amount}"/><feFuncB type="linear" slope="${amount}"/></feComponentTransfer></filter>',{amount:c.isFinite(a.amount)?a.amount:1})},contrast:function(a){var b=c.isFinite(a.amount)?a.amount:1;return c.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}" intercept="${amount2}"/><feFuncG type="linear" slope="${amount}" intercept="${amount2}"/><feFuncB type="linear" slope="${amount}" intercept="${amount2}"/></feComponentTransfer></filter>',{amount:b,amount2:.5-b/2})}},format:{number:function(a,b,c){function d(a){for(var b=a.length,d=[],e=0,f=c.grouping[0];b>0&&f>0;)d.push(a.substring(b-=f,b+f)),f=c.grouping[e=(e+1)%c.grouping.length];return d.reverse().join(c.thousands)}c=c||{currency:["$",""],decimal:".",thousands:",",grouping:[3]};var e=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i,f=e.exec(a),g=f[1]||" ",h=f[2]||">",i=f[3]||"",j=f[4]||"",k=f[5],l=+f[6],m=f[7],n=f[8],o=f[9],p=1,q="",r="",s=!1;switch(n&&(n=+n.substring(1)),(k||"0"===g&&"="===h)&&(k=g="0",h="=",m&&(l-=Math.floor((l-1)/4))),o){case"n":m=!0,o="g";break;case"%":p=100,r="%",o="f";break;case"p":p=100,r="%",o="r";break;case"b":case"o":case"x":case"X":"#"===j&&(q="0"+o.toLowerCase());case"c":case"d":s=!0,n=0;break;case"s":p=-1,o="r"}"$"===j&&(q=c.currency[0],r=c.currency[1]),"r"!=o||n||(o="g"),null!=n&&("g"==o?n=Math.max(1,Math.min(21,n)):("e"==o||"f"==o)&&(n=Math.max(0,Math.min(20,n))));var t=k&&m;if(s&&b%1)return"";var u=0>b||0===b&&0>1/b?(b=-b,"-"):i,v=r;if(0>p){var w=this.prefix(b,n);b=w.scale(b),v=w.symbol+r}else b*=p;b=this.convert(o,b,n);var x=b.lastIndexOf("."),y=0>x?b:b.substring(0,x),z=0>x?"":c.decimal+b.substring(x+1);!k&&m&&c.grouping&&(y=d(y));var A=q.length+y.length+z.length+(t?0:u.length),B=l>A?new Array(A=l-A+1).join(g):"";return t&&(y=d(B+y)),u+=q,b=y+z,("<"===h?u+b+B:">"===h?B+u+b:"^"===h?B.substring(0,A>>=1)+u+b+B.substring(A):u+(t?b:B+b))+v},string:function(a,b){for(var c,d="{",e=!1,f=[];-1!==(c=a.indexOf(d));){var g,h,i;if(g=a.slice(0,c),e){h=g.split(":"),i=h.shift().split("."),g=b;for(var j=0;j<i.length;j++)g=g[i[j]];h.length&&(g=this.number(h,g))}f.push(g),a=a.slice(c+1),d=(e=!e)?"}":"{"}return f.push(a),f.join("")},convert:function(a,b,c){switch(a){case"b":return b.toString(2);case"c":return String.fromCharCode(b);case"o":return b.toString(8);case"x":return b.toString(16);case"X":return b.toString(16).toUpperCase();case"g":return b.toPrecision(c);case"e":return b.toExponential(c);case"f":return b.toFixed(c);case"r":return(b=this.round(b,this.precision(b,c))).toFixed(Math.max(0,Math.min(20,this.precision(b*(1+1e-15),c))));default:return b+""}},round:function(a,b){return b?Math.round(a*(b=Math.pow(10,b)))/b:Math.round(a)},precision:function(a,b){return b-(a?Math.ceil(Math.log(a)/Math.LN10):1)},prefix:function(a,b){var d=c.map(["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"],function(a,b){var c=Math.pow(10,3*abs(8-b));return{scale:b>8?function(a){return a/c}:function(a){return a*c},symbol:a}}),e=0;return a&&(0>a&&(a*=-1),b&&(a=this.round(a,this.precision(a,b))),e=1+Math.floor(1e-12+Math.log(a)/Math.LN10),e=Math.max(-24,Math.min(24,3*Math.floor((0>=e?e+1:e-1)/3)))),d[8+e/3]}}}};return g.dia.GraphCells=b.Collection.extend({initialize:function(){this.on("change:z",this.sort,this)},model:function(a,b){if("link"===a.type)return new g.dia.Link(a,b);var c=a.type.split(".")[0],d=a.type.split(".")[1];return g.shapes[c]&&g.shapes[c][d]?new g.shapes[c][d](a,b):new g.dia.Element(a,b)},comparator:function(a){return a.get("z")||0},getConnectedLinks:function(a,b){b=b||{},c.isUndefined(b.inbound)&&c.isUndefined(b.outbound)&&(b.inbound=b.outbound=!0);var d=this.filter(function(c){var d=c.get("source"),e=c.get("target");return d&&d.id===a.id&&b.outbound||e&&e.id===a.id&&b.inbound});if(b.deep){var e=a.getEmbeddedCells({deep:!0});c.each(this.difference(d,e),function(a){if(b.outbound){var f=a.get("source");if(f&&f.id&&c.find(e,{id:f.id}))return void d.push(a)}if(b.inbound){var g=a.get("target");g&&g.id&&c.find(e,{id:g.id})&&d.push(a)}})}return d},getCommonAncestor:function(){var a=c.map(arguments,function(a){for(var b=[a.id],c=a.get("parent");c;)b.push(c),c=this.get(c).get("parent");return b},this);a=c.sortBy(a,"length");var b=c.find(a.shift(),function(b){return c.every(a,function(a){return c.contains(a,b)})});return this.get(b)},getBBox:function(a){a=a||this.models;var b={x:1/0,y:1/0},d={x:-(1/0),y:-(1/0)};return c.each(a,function(a){if(!a.isLink()){var c=a.getBBox();b.x=Math.min(b.x,c.x),b.y=Math.min(b.y,c.y),d.x=Math.max(d.x,c.x+c.width),d.y=Math.max(d.y,c.y+c.height)}}),e.rect(b.x,b.y,d.x-b.x,d.y-b.y)}}),g.dia.Graph=b.Model.extend({initialize:function(a,b){this.set("cells",new g.dia.GraphCells([],{model:b&&b.cellModel})),this.get("cells").on("all",this.trigger,this),this.get("cells").on("remove",this.removeCell,this)},toJSON:function(){var a=b.Model.prototype.toJSON.apply(this,arguments);return a.cells=this.get("cells").toJSON(),a},fromJSON:function(a,b){if(!a.cells)throw new Error("Graph JSON must contain cells array.");this.set(c.omit(a,"cells"),b),this.resetCells(a.cells,b)},clear:function(a){this.trigger("batch:start"),this.get("cells").remove(this.get("cells").models,a),this.trigger("batch:stop")},_prepareCell:function(a){return a instanceof b.Model&&c.isUndefined(a.get("z"))?a.set("z",this.maxZIndex()+1,{silent:!0}):c.isUndefined(a.z)&&(a.z=this.maxZIndex()+1),a},maxZIndex:function(){var a=this.get("cells").last();return a?a.get("z")||0:0},addCell:function(a,b){return c.isArray(a)?this.addCells(a,b):(this.get("cells").add(this._prepareCell(a),b||{}),this)},addCells:function(a,b){return b=b||{},b.position=a.length,c.each(a,function(a){b.position--,this.addCell(a,b)},this),this},resetCells:function(a,b){return this.get("cells").reset(c.map(a,this._prepareCell,this),b),this},removeCell:function(a,b,c){c&&c.disconnectLinks?this.disconnectLinks(a,c):this.removeLinks(a,c),this.get("cells").remove(a,{silent:!0})},getCell:function(a){return this.get("cells").get(a)},getElements:function(){return this.get("cells").filter(function(a){return a instanceof g.dia.Element})},getLinks:function(){return this.get("cells").filter(function(a){return a instanceof g.dia.Link})},getConnectedLinks:function(a,b){return this.get("cells").getConnectedLinks(a,b)},getNeighbors:function(a){var b=this.getConnectedLinks(a),d=[],e=this.get("cells");return c.each(b,function(b){var c=b.get("source"),f=b.get("target");if(!c.x){var g=e.get(c.id);g!==a&&d.push(g)}if(!f.x){var h=e.get(f.id);h!==a&&d.push(h)}}),d},disconnectLinks:function(a,b){c.each(this.getConnectedLinks(a),function(c){c.set(c.get("source").id===a.id?"source":"target",e.point(0,0),b)})},removeLinks:function(a,b){c.invoke(this.getConnectedLinks(a),"remove",b)},findModelsFromPoint:function(a){return c.filter(this.getElements(),function(b){return b.getBBox().containsPoint(a)})},findModelsInArea:function(a){return c.filter(this.getElements(),function(b){return b.getBBox().intersect(a)})},getBBox:function(){var a=this.get("cells");return a.getBBox.apply(a,arguments)},getCommonAncestor:function(){var a=this.get("cells");return a.getCommonAncestor.apply(a,arguments)}}),g.dia.Cell=b.Model.extend({constructor:function(a,b){var d,e=a||{};this.cid=c.uniqueId("c"),this.attributes={},b&&b.collection&&(this.collection=b.collection),b&&b.parse&&(e=this.parse(e,b)||{}),(d=c.result(this,"defaults"))&&(e=c.merge({},d,e)),this.set(e,b),this.changed={},this.initialize.apply(this,arguments)},toJSON:function(){var a=this.constructor.prototype.defaults.attrs||{},b=this.attributes.attrs,d={};c.each(b,function(b,e){var f=a[e];c.each(b,function(a,b){c.isObject(a)&&!c.isArray(a)?c.each(a,function(a,g){f&&f[b]&&c.isEqual(f[b][g],a)||(d[e]=d[e]||{},(d[e][b]||(d[e][b]={}))[g]=a)}):f&&c.isEqual(f[b],a)||(d[e]=d[e]||{},d[e][b]=a)})});var e=c.cloneDeep(c.omit(this.attributes,"attrs"));return e.attrs=d,e},initialize:function(a){a&&a.id||this.set("id",g.util.uuid(),{silent:!0}),this._transitionIds={},this.processPorts(),this.on("change:attrs",this.processPorts,this)},processPorts:function(){var a=this.ports,b={};c.each(this.get("attrs"),function(a,d){a&&a.port&&(c.isUndefined(a.port.id)?b[a.port]={id:a.port}:b[a.port.id]=a.port)});var d={};if(c.each(a,function(a,c){b[c]||(d[c]=!0)}),this.collection&&!c.isEmpty(d)){var e=this.collection.getConnectedLinks(this,{inbound:!0});c.each(e,function(a){d[a.get("target").port]&&a.remove()});var f=this.collection.getConnectedLinks(this,{outbound:!0});c.each(f,function(a){d[a.get("source").port]&&a.remove()})}this.ports=b},remove:function(a){a=a||{};var b=this.collection;b&&b.trigger("batch:start",{batchName:"remove"});var d=this.get("parent");if(d){var e=this.collection&&this.collection.get(d);e.unembed(this)}return c.invoke(this.getEmbeddedCells(),"remove",a),this.trigger("remove",this,this.collection,a),b&&b.trigger("batch:stop",{batchName:"remove"}),this},toFront:function(a){if(this.collection){a=a||{};var b=(this.collection.last().get("z")||0)+1;if(this.trigger("batch:start",{batchName:"to-front"}).set("z",b,a),a.deep){var d=this.getEmbeddedCells({deep:!0,breadthFirst:!0});c.each(d,function(c){c.set("z",++b,a)})}this.trigger("batch:stop",{batchName:"to-front"})}return this},toBack:function(a){if(this.collection){a=a||{};var b=(this.collection.first().get("z")||0)-1;if(this.trigger("batch:start",{batchName:"to-back"}),a.deep){var d=this.getEmbeddedCells({deep:!0,breadthFirst:!0});c.eachRight(d,function(c){c.set("z",b--,a)})}this.set("z",b,a).trigger("batch:stop",{batchName:"to-back"})}return this},embed:function(a,b){if(this==a||this.isEmbeddedIn(a))throw new Error("Recursive embedding not allowed.");this.trigger("batch:start",{batchName:"embed"});var d=c.clone(this.get("embeds")||[]);return d[a.isLink()?"unshift":"push"](a.id),a.set("parent",this.id,b),this.set("embeds",c.uniq(d),b),this.trigger("batch:stop",{batchName:"embed"}),this},unembed:function(a,b){return this.trigger("batch:start",{batchName:"unembed"}),a.unset("parent",b),this.set("embeds",c.without(this.get("embeds"),a.id),b),this.trigger("batch:stop",{batchName:"unembed"}),this},getAncestors:function(){var a=[],b=this.get("parent");if(void 0===this.collection)return a;for(;void 0!==b;){var c=this.collection.get(b);if(void 0===c)break;a.push(c),b=c.get("parent")}return a},getEmbeddedCells:function(a){if(a=a||{},this.collection){var b;if(a.deep)if(a.breadthFirst){b=[];for(var d=this.getEmbeddedCells();d.length>0;){var e=d.shift();b.push(e),d.push.apply(d,e.getEmbeddedCells())}}else b=this.getEmbeddedCells(),c.each(b,function(c){b.push.apply(b,c.getEmbeddedCells(a))});else b=c.map(this.get("embeds"),this.collection.get,this.collection);return b}return[]},isEmbeddedIn:function(a,b){var d=c.isString(a)?a:a.id,e=this.get("parent");if(b=c.defaults({deep:!0},b),this.collection&&b.deep){for(;e;){if(e==d)return!0;e=this.collection.get(e).get("parent")}return!1}return e==d},clone:function(a){a=a||{};var d=b.Model.prototype.clone.apply(this,arguments);if(d.set("id",g.util.uuid(),{silent:!0}),d.set("embeds",""),!a.deep)return d;var e=c.sortBy(this.getEmbeddedCells(),function(a){return a instanceof g.dia.Element}),f=[d],h={};return c.each(e,function(a){var b=a.clone({deep:!0});d.embed(b[0]),c.each(b,function(b){if(b instanceof g.dia.Link)return b.get("source").id==this.id&&b.prop("source",{id:d.id}),b.get("target").id==this.id&&b.prop("target",{id:d.id}),void(h[a.id]=b);f.push(b);var e=this.collection.getConnectedLinks(a,{inbound:!0});c.each(e,function(a){var c=h[a.id]||a.clone();h[a.id]=c,c.prop("target",{id:b.id})});var i=this.collection.getConnectedLinks(a,{outbound:!0});c.each(i,function(a){var c=h[a.id]||a.clone();h[a.id]=c,c.prop("source",{id:b.id})})},this)},this),f=f.concat(c.values(h))},prop:function(a,b,d){var e="/";if(c.isString(a)){if(arguments.length>1){var f=a,h=f.split("/"),i=h[0];if(d=d||{},d.propertyPath=f,d.propertyValue=b,1==h.length)return this.set(i,b,d);var j={},k=j,l=i;c.each(c.rest(h),function(a){k=k[l]=c.isFinite(Number(a))?[]:{},l=a}),j=g.util.setByPath(j,f,b,"/");var m=c.merge({},this.attributes);d.rewrite&&g.util.unsetByPath(m,f,"/");var n=c.merge(m,j);return this.set(i,n[i],d)}return g.util.getByPath(this.attributes,a,e)}return this.set(c.merge({},this.attributes,a),b)},removeProp:function(a,b){b=b||{},b.dirty=!0;var d=a.split("/");if(1===d.length)return this.unset(a,b);var e=d[0],f=d.slice(1).join("/"),h=c.merge({},this.get(e));return g.util.unsetByPath(h,f,"/"),this.set(e,h,b)},attr:function(a,b,d){var e=Array.prototype.slice.call(arguments);return c.isString(a)?e[0]="attrs/"+a:e[0]={attrs:a},this.prop.apply(this,e)},removeAttr:function(a,b){return c.isArray(a)?(c.each(a,function(a){this.removeAttr(a,b)},this),this):this.removeProp("attrs/"+a,b)},transition:function(a,b,d,e){e=e||"/";var f={duration:100,delay:10,timingFunction:g.util.timing.linear,valueFunction:g.util.interpolate.number};d=c.extend(f,d);var h,i=0,j=c.bind(function(b){var c,e,f;i=i||b,b-=i,e=b/d.duration,1>e?this._transitionIds[a]=c=g.util.nextFrame(j):(e=1,delete this._transitionIds[a]),f=h(d.timingFunction(e)),d.transitionId=c,this.prop(a,f,d),c||this.trigger("transition:end",this,a)},this),k=c.bind(function(c){this.stopTransitions(a),h=d.valueFunction(g.util.getByPath(this.attributes,a,e),b),this._transitionIds[a]=g.util.nextFrame(c),this.trigger("transition:start",this,a)},this);return c.delay(k,d.delay,j)},getTransitions:function(){return c.keys(this._transitionIds)},stopTransitions:function(a,b){b=b||"/";var d=a&&a.split(b);return c(this._transitionIds).keys().filter(d&&function(a){return c.isEqual(d,a.split(b).slice(0,d.length))}).each(function(a){g.util.cancelFrame(this._transitionIds[a]),delete this._transitionIds[a],this.trigger("transition:end",this,a)},this),this},addTo:function(a,b){return a.addCell(this,b),this},findView:function(a){return a.findViewByModel(this)},isLink:function(){return!1}}),g.dia.CellView=b.View.extend({tagName:"g",attributes:function(){return{"model-id":this.model.id}},constructor:function(a){this._configure(a),b.View.apply(this,arguments)},_configure:function(a){this.options&&(a=c.extend({},c.result(this,"options"),a)),this.options=a,this.options.id=this.options.id||g.util.guid(this)},initialize:function(){c.bindAll(this,"remove","update"),this.$el.data("view",this),this.listenTo(this.model,"remove",this.remove),this.listenTo(this.model,"change:attrs",this.onChangeAttrs)},onChangeAttrs:function(a,b,c){return c.dirty?this.render():this.update()},_ensureElement:function(){var a;if(this.el)a=c.result(this,"el");else{var b=c.extend({id:this.id},c.result(this,"attributes"));this.className&&(b["class"]=c.result(this,"className")),a=f(c.result(this,"tagName"),b).node}this.setElement(a,!1)},_setElement:function(a){this.$el=a instanceof b.$?a:b.$(a),this.el=this.$el[0],this.vel=f(this.el)},findBySelector:function(a){var b="."===a?this.$el:this.$el.find(a);return b},notify:function(a){if(this.paper){var b=Array.prototype.slice.call(arguments,1);this.trigger.apply(this,[a].concat(b)),this.paper.trigger.apply(this.paper,[a,this].concat(b))}},getStrokeBBox:function(a){var b=!!a;a=a||this.el;var c,d=f(a).bbox(!1,this.paper.viewport);return c=b?f(a).attr("stroke-width"):this.model.attr("rect/stroke-width")||this.model.attr("circle/stroke-width")||this.model.attr("ellipse/stroke-width")||this.model.attr("path/stroke-width"),c=parseFloat(c)||0,e.rect(d).moveAndExpand({x:-c/2,y:-c/2,width:c,height:c})},getBBox:function(){return e.rect(this.vel.bbox())},highlight:function(a,b){return a=a?this.$(a)[0]||this.el:this.el,b=b||{},b.partial=a!=this.el,this.notify("cell:highlight",a,b),this},unhighlight:function(a,b){return a=a?this.$(a)[0]||this.el:this.el,b=b||{},b.partial=a!=this.el,this.notify("cell:unhighlight",a,b),this},findMagnet:function(a){var b=this.$(a);if(0===b.length||b[0]===this.el){var c=this.model.get("attrs")||{};return c["."]&&c["."].magnet===!1?void 0:this.el}return b.attr("magnet")?b[0]:this.findMagnet(b.parent())},applyFilter:function(a,b){var e=c.isString(a)?this.findBySelector(a):d(a),h=b.name+this.paper.svg.id+g.util.hashCode(JSON.stringify(b));if(!this.paper.svg.getElementById(h)){var i=g.util.filter[b.name]&&g.util.filter[b.name](b.args||{});if(!i)throw new Error("Non-existing filter "+b.name);var j=f(i);j.attr({filterUnits:"objectBoundingBox",x:-1,y:-1,width:3,height:3}),b.attrs&&j.attr(b.attrs),j.node.id=h,f(this.paper.svg).defs().append(j)}e.each(function(){f(this).attr("filter","url(#"+h+")")})},applyGradient:function(a,b,e){var h=c.isString(a)?this.findBySelector(a):d(a),i=e.type+this.paper.svg.id+g.util.hashCode(JSON.stringify(e));if(!this.paper.svg.getElementById(i)){var j=["<"+e.type+">",c.map(e.stops,function(a){return'<stop offset="'+a.offset+'" stop-color="'+a.color+'" stop-opacity="'+(c.isFinite(a.opacity)?a.opacity:1)+'" />'}).join(""),"</"+e.type+">"].join(""),k=f(j);e.attrs&&k.attr(e.attrs),k.node.id=i,f(this.paper.svg).defs().append(k)}h.each(function(){f(this).attr(b,"url(#"+i+")")})},getSelector:function(a,b){if(a===this.el)return b;var c=f(a).index()+1,d=a.tagName+":nth-child("+c+")";return b&&(d+=" > "+b),this.getSelector(a.parentNode,d)},pointerdblclick:function(a,b,c){this.notify("cell:pointerdblclick",a,b,c)},pointerclick:function(a,b,c){this.notify("cell:pointerclick",a,b,c)},pointerdown:function(a,b,c){this.model.collection&&(this.model.trigger("batch:start",{batchName:"pointer"}),this._collection=this.model.collection),this.notify("cell:pointerdown",a,b,c)},pointermove:function(a,b,c){this.notify("cell:pointermove",a,b,c)},pointerup:function(a,b,c){this.notify("cell:pointerup",a,b,c),this._collection&&(this._collection.trigger("batch:stop",{batchName:"pointer"}),delete this._collection)},mouseover:function(a){this.notify("cell:mouseover",a)},mouseout:function(a){this.notify("cell:mouseout",a)},contextmenu:function(a,b,c){this.notify("cell:contextmenu",a,b,c)}}),g.dia.Element=g.dia.Cell.extend({defaults:{position:{x:0,y:0},size:{width:1,height:1},angle:0},position:function(a,b,d){var f=c.isNumber(b);if(d=(f?d:a)||{},d.parentRelative){if(!this.collection)throw new Error("Element must be part of a collection.");var g=this.collection.get(this.get("parent")),h=g&&!g.isLink()?g.get("position"):{x:0,y:0}}if(f)return d.parentRelative&&(a+=h.x,b+=h.y),this.set("position",{x:a,y:b},d);var i=e.point(this.get("position"));return d.parentRelative?i.difference(h):i},translate:function(a,b,d){if(b=b||0,0===a&&0===b)return this;d=d||{},d.translateBy=d.translateBy||this.id,d.tx=a,d.ty=b;var e=this.get("position")||{x:0,y:0},f={x:e.x+a||0,y:e.y+b||0};return d.transition?(c.isObject(d.transition)||(d.transition={}),this.transition("position",f,c.extend({},d.transition,{valueFunction:g.util.interpolate.object}))):(this.set("position",f,d),c.invoke(this.getEmbeddedCells(),"translate",a,b,d)),this},resize:function(a,b,c){return this.trigger("batch:start",{batchName:"resize"}),this.set("size",{width:a,height:b},c),this.trigger("batch:stop",{batchName:"resize"}),this},fitEmbeds:function(a){a=a||0;var b=this.collection;if(!b)throw new Error("Element must be part of a collection.");var d=this.getEmbeddedCells();if(d.length>0){this.trigger("batch:start",{batchName:"fit-embeds"}),a.deep&&c.invoke(d,"fitEmbeds",a);var e=b.getBBox(d),f=g.util.normalizeSides(a.padding);e.moveAndExpand({x:-f.left,y:-f.top,width:f.right+f.left,height:f.bottom+f.top}),this.set({position:{x:e.x,y:e.y},size:{width:e.width,height:e.height}},a),this.trigger("batch:stop",{batchName:"fit-embeds"})}return this},rotate:function(a,b,c){if(c){var d=this.getBBox().center(),e=this.get("size"),f=this.get("position");d.rotate(c,this.get("angle")-a);var g=d.x-e.width/2-f.x,h=d.y-e.height/2-f.y;this.trigger("batch:start",{batchName:"rotate"}),this.translate(g,h),this.rotate(a,b),this.trigger("batch:stop",{batchName:"rotate"})}else this.set("angle",b?a:(this.get("angle")+a)%360);return this},getBBox:function(){var a=this.get("position"),b=this.get("size");return e.rect(a.x,a.y,b.width,b.height)}}),g.dia.ElementView=g.dia.CellView.extend({SPECIAL_ATTRIBUTES:["style","text","html","ref-x","ref-y","ref-dx","ref-dy","ref-width","ref-height","ref","x-alignment","y-alignment","port"],className:function(){return"element "+this.model.get("type").replace("."," ","g")},initialize:function(){c.bindAll(this,"translate","resize","rotate"),g.dia.CellView.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:position",this.translate),this.listenTo(this.model,"change:size",this.resize),this.listenTo(this.model,"change:angle",this.rotate)},update:function(a,b){var e=this.model.get("attrs"),g=this.rotatableNode;if(g){var h=g.attr("transform");g.attr("transform","")}var i=[],j={};c.each(b||e,function(a,b){
var e=this.findBySelector(b);if(0!==e.length){j[b]=e;var g=this.SPECIAL_ATTRIBUTES.slice();c.isObject(a.filter)&&(g.push("filter"),this.applyFilter(e,a.filter)),c.isObject(a.fill)&&(g.push("fill"),this.applyGradient(e,"fill",a.fill)),c.isObject(a.stroke)&&(g.push("stroke"),this.applyGradient(e,"stroke",a.stroke)),c.isUndefined(a.text)||(e.each(function(){f(this).text(a.text+"",{lineHeight:a.lineHeight,textPath:a.textPath,annotations:a.annotations})}),g.push("lineHeight","textPath","annotations"));var h=c.omit(a,g);e.each(function(){f(this).attr(h)}),a.port&&e.attr("port",c.isUndefined(a.port.id)?a.port:a.port.id),a.style&&e.css(a.style),c.isUndefined(a.html)||e.each(function(){d(this).html(a.html+"")}),c.isUndefined(a["ref-x"])&&c.isUndefined(a["ref-y"])&&c.isUndefined(a["ref-dx"])&&c.isUndefined(a["ref-dy"])&&c.isUndefined(a["x-alignment"])&&c.isUndefined(a["y-alignment"])&&c.isUndefined(a["ref-width"])&&c.isUndefined(a["ref-height"])||c.each(e,function(a,b,c){var e=d(a);e.selector=c.selector,i.push(e)})}},this);var k=this.model.get("size"),l={x:0,y:0,width:k.width,height:k.height};b=b||{},c.each(i,function(a){var d=b[a.selector],g=d?c.merge({},e[a.selector],d):e[a.selector];this.positionRelative(f(a[0]),l,g,j)},this),g&&g.attr("transform",h||"")},positionRelative:function(a,b,d,e){var g=d.ref,h=parseFloat(d["ref-dx"]),i=parseFloat(d["ref-dy"]),j=d["y-alignment"],k=d["x-alignment"],l=d["ref-y"],m=c.isString(l)&&"%"===l.slice(-1);l=parseFloat(l),m&&(l/=100);var n=d["ref-x"],o=c.isString(n)&&"%"===n.slice(-1);n=parseFloat(n),o&&(n/=100);var p=d["ref-width"],q=c.isString(p)&&"%"===p.slice(-1);p=parseFloat(p),q&&(p/=100);var r=d["ref-height"],s=c.isString(r)&&"%"===r.slice(-1);r=parseFloat(r),s&&(r/=100);var t=a.findParentByClass("scalable",this.el);if(g){var u;if(u=e&&e[g]?f(e[g][0]):"."===g?this.vel:this.vel.findOne(g),!u)throw new Error("dia.ElementView: reference does not exists.");b=u.bbox(!1,this.el)}a.attr("transform")&&a.attr("transform",a.attr("transform").replace(/translate\([^)]*\)/g,"").trim()||""),isFinite(p)&&(q||p>=0&&1>=p?a.attr("width",p*b.width):a.attr("width",Math.max(p+b.width,0))),isFinite(r)&&(s||r>=0&&1>=r?a.attr("height",r*b.height):a.attr("height",Math.max(r+b.height,0)));var v,w=0,x=0;if(isFinite(h)&&(t?(v=v||t.scale(),w=b.x+b.width+h/v.sx):w=b.x+b.width+h),isFinite(i)&&(t?(v=v||t.scale(),x=b.y+b.height+i/v.sy):x=b.y+b.height+i),isFinite(n)&&(o||n>0&&1>n?w=b.x+b.width*n:t?(v=v||t.scale(),w=b.x+n/v.sx):w=b.x+n),isFinite(l)&&(o||l>0&&1>l?x=b.y+b.height*l:t?(v=v||t.scale(),x=b.y+l/v.sy):x=b.y+l),!c.isUndefined(j)||!c.isUndefined(k)){var y=a.bbox(!1,this.paper.viewport);"middle"===j?x-=y.height/2:isFinite(j)&&(x+=j>-1&&1>j?y.height*j:j),"middle"===k?w-=y.width/2:isFinite(k)&&(w+=k>-1&&1>k?y.width*k:k)}a.translate(w,x)},renderMarkup:function(){var a=this.model.markup||this.model.get("markup");if(!a)throw new Error("properties.markup is missing while the default render() implementation is used.");var b=f(a);this.vel.append(b)},render:function(){return this.$el.empty(),this.renderMarkup(),this.rotatableNode=this.vel.findOne(".rotatable"),this.scalableNode=this.vel.findOne(".scalable"),this.update(),this.resize(),this.rotate(),this.translate(),this},scale:function(a,b){this.vel.scale(a,b)},resize:function(){var a=this.model.get("size")||{width:1,height:1},b=this.model.get("angle")||0,c=this.scalableNode;if(c){var d=c.bbox(!0);c.attr("transform","scale("+a.width/(d.width||1)+","+a.height/(d.height||1)+")");var e=this.rotatableNode,f=e&&e.attr("transform");if(f&&"null"!==f){e.attr("transform",f+" rotate("+-b+","+a.width/2+","+a.height/2+")");var g=c.bbox(!1,this.paper.viewport);this.model.set("position",{x:g.x,y:g.y}),this.rotate()}this.update()}},translate:function(a,b,c){var d=this.model.get("position")||{x:0,y:0};this.vel.attr("transform","translate("+d.x+","+d.y+")")},rotate:function(){var a=this.rotatableNode;if(a){var b=this.model.get("angle")||0,c=this.model.get("size")||{width:1,height:1},d=c.width/2,e=c.height/2;a.attr("transform","rotate("+b+","+d+","+e+")")}},getBBox:function(a){if(a&&a.useModelGeometry){var b=this.model.getBBox().bbox(this.model.get("angle")),c=this.paper.viewport.getCTM();return e.rect(f.transformRect(b,c))}return g.dia.CellView.prototype.getBBox.apply(this,arguments)},findParentsByKey:function(a){var b=this.model.getBBox();return"bbox"==a?this.paper.model.findModelsInArea(b):this.paper.model.findModelsFromPoint(b[a]())},prepareEmbedding:function(){this.model.toFront({deep:!0,ui:!0}),c.invoke(this.paper.model.getConnectedLinks(this.model,{deep:!0}),"toFront",{ui:!0});var a=this.model.get("parent");a&&this.paper.model.getCell(a).unembed(this.model,{ui:!0})},processEmbedding:function(a){a=a||this.paper.options;var b=this.findParentsByKey(a.findParentBy);b=c.reject(b,function(a){return this.model.id==a.id||a.isEmbeddedIn(this.model)},this),a.frontParentOnly&&(b=b.slice(-1));for(var d=null,e=this._candidateEmbedView,f=b.length-1;f>=0;f--){var g=b[f];if(e&&e.model.id==g.id){d=e;break}var h=g.findView(this.paper);if(a.validateEmbedding.call(this.paper,this,h)){d=h;break}}d&&d!=e&&(e&&e.unhighlight(null,{embedding:!0}),this._candidateEmbedView=d.highlight(null,{embedding:!0})),!d&&e&&(e.unhighlight(null,{embedding:!0}),delete this._candidateEmbedView)},finalizeEmbedding:function(){var a=this._candidateEmbedView;a&&(a.model.embed(this.model,{ui:!0}),a.unhighlight(null,{embedding:!0}),delete this._candidateEmbedView),c.invoke(this.paper.model.getConnectedLinks(this.model,{deep:!0}),"reparent",{ui:!0})},pointerdown:function(a,b,c){if(a.target.getAttribute("magnet")&&this.paper.options.validateMagnet.call(this.paper,this,a.target)){this.model.trigger("batch:start",{batchName:"add-link"});var e=this.paper.getDefaultLink(this,a.target);e.set({source:{id:this.model.id,selector:this.getSelector(a.target),port:d(a.target).attr("port")},target:{x:b,y:c}}),this.paper.model.addCell(e),this._linkView=this.paper.findViewByModel(e),this._linkView.pointerdown(a,b,c),this._linkView.startArrowheadMove("target")}else this._dx=b,this._dy=c,g.dia.CellView.prototype.pointerdown.apply(this,arguments),this.notify("element:pointerdown",a,b,c)},pointermove:function(a,b,d){if(this._linkView)this._linkView.pointermove(a,b,d);else{var f=this.paper.options.gridSize,h=c.isFunction(this.options.interactive)?this.options.interactive(this,"pointermove"):this.options.interactive;if(h!==!1){var i=this.model.get("position");this.model.translate(e.snapToGrid(i.x,f)-i.x+e.snapToGrid(b-this._dx,f),e.snapToGrid(i.y,f)-i.y+e.snapToGrid(d-this._dy,f)),this.paper.options.embeddingMode&&(this._inProcessOfEmbedding||(this.prepareEmbedding(),this._inProcessOfEmbedding=!0),this.processEmbedding())}this._dx=e.snapToGrid(b,f),this._dy=e.snapToGrid(d,f),g.dia.CellView.prototype.pointermove.apply(this,arguments),this.notify("element:pointermove",a,b,d)}},pointerup:function(a,b,c){this._linkView?(this._linkView.pointerup(a,b,c),delete this._linkView,this.model.trigger("batch:stop",{batchName:"add-link"})):(this._inProcessOfEmbedding&&(this.finalizeEmbedding(),this._inProcessOfEmbedding=!1),this.notify("element:pointerup",a,b,c),g.dia.CellView.prototype.pointerup.apply(this,arguments))}}),g.dia.Link=g.dia.Cell.extend({markup:['<path class="connection" stroke="black"/>','<path class="marker-source" fill="black" stroke="black" />','<path class="marker-target" fill="black" stroke="black" />','<path class="connection-wrap"/>','<g class="labels"/>','<g class="marker-vertices"/>','<g class="marker-arrowheads"/>','<g class="link-tools"/>'].join(""),labelMarkup:['<g class="label">',"<rect />","<text />","</g>"].join(""),toolMarkup:['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle r="11" />','<path transform="scale(.8) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z"/>',"<title>Remove link.</title>","</g>",'<g class="tool-options" event="link:options">','<circle r="11" transform="translate(25)"/>','<path fill="white" transform="scale(.55) translate(29, -16)" d="M31.229,17.736c0.064-0.571,0.104-1.148,0.104-1.736s-0.04-1.166-0.104-1.737l-4.377-1.557c-0.218-0.716-0.504-1.401-0.851-2.05l1.993-4.192c-0.725-0.91-1.549-1.734-2.458-2.459l-4.193,1.994c-0.647-0.347-1.334-0.632-2.049-0.849l-1.558-4.378C17.165,0.708,16.588,0.667,16,0.667s-1.166,0.041-1.737,0.105L12.707,5.15c-0.716,0.217-1.401,0.502-2.05,0.849L6.464,4.005C5.554,4.73,4.73,5.554,4.005,6.464l1.994,4.192c-0.347,0.648-0.632,1.334-0.849,2.05l-4.378,1.557C0.708,14.834,0.667,15.412,0.667,16s0.041,1.165,0.105,1.736l4.378,1.558c0.217,0.715,0.502,1.401,0.849,2.049l-1.994,4.193c0.725,0.909,1.549,1.733,2.459,2.458l4.192-1.993c0.648,0.347,1.334,0.633,2.05,0.851l1.557,4.377c0.571,0.064,1.148,0.104,1.737,0.104c0.588,0,1.165-0.04,1.736-0.104l1.558-4.377c0.715-0.218,1.399-0.504,2.049-0.851l4.193,1.993c0.909-0.725,1.733-1.549,2.458-2.458l-1.993-4.193c0.347-0.647,0.633-1.334,0.851-2.049L31.229,17.736zM16,20.871c-2.69,0-4.872-2.182-4.872-4.871c0-2.69,2.182-4.872,4.872-4.872c2.689,0,4.871,2.182,4.871,4.872C20.871,18.689,18.689,20.871,16,20.871z"/>',"<title>Link options.</title>","</g>","</g>"].join(""),vertexMarkup:['<g class="marker-vertex-group" transform="translate(<%= x %>, <%= y %>)">','<circle class="marker-vertex" idx="<%= idx %>" r="10" />','<path class="marker-vertex-remove-area" idx="<%= idx %>" d="M16,5.333c-7.732,0-14,4.701-14,10.5c0,1.982,0.741,3.833,2.016,5.414L2,25.667l5.613-1.441c2.339,1.317,5.237,2.107,8.387,2.107c7.732,0,14-4.701,14-10.5C30,10.034,23.732,5.333,16,5.333z" transform="translate(5, -33)"/>','<path class="marker-vertex-remove" idx="<%= idx %>" transform="scale(.8) translate(9.5, -37)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z">',"<title>Remove vertex.</title>","</path>","</g>"].join(""),arrowheadMarkup:['<g class="marker-arrowhead-group marker-arrowhead-group-<%= end %>">','<path class="marker-arrowhead" end="<%= end %>" d="M 26 0 L 0 13 L 26 26 z" />',"</g>"].join(""),defaults:{type:"link",source:{},target:{}},disconnect:function(){return this.set({source:e.point(0,0),target:e.point(0,0)})},label:function(a,b){a=a||0;var d=this.get("labels")||[];if(0===arguments.length||1===arguments.length)return d[a];var e=c.merge({},d[a],b),f=d.slice();return f[a]=e,this.set({labels:f})},translate:function(a,b,d){var e={},f=this.get("source"),g=this.get("target"),h=this.get("vertices");return f.id||(e.source={x:f.x+a,y:f.y+b}),g.id||(e.target={x:g.x+a,y:g.y+b}),h&&h.length&&(e.vertices=c.map(h,function(c){return{x:c.x+a,y:c.y+b}})),this.set(e,d)},reparent:function(a){var b;if(this.collection){var c=this.collection.get(this.get("source").id),d=this.collection.get(this.get("target").id),e=this.collection.get(this.get("parent"));c&&d&&(b=this.collection.getCommonAncestor(c,d)),!e||b&&b.id==e.id||e.unembed(this,a),b&&b.embed(this,a)}return b},isLink:function(){return!0},hasLoop:function(){var a=this.get("source").id,b=this.get("target").id;return a&&b&&a==b}}),g.dia.LinkView=g.dia.CellView.extend({className:function(){return c.unique(this.model.get("type").split(".").concat("link")).join(" ")},options:{shortLinkLength:100,doubleLinkTools:!1,longLinkLength:160,linkToolsOffset:40,doubleLinkToolsOffset:60,sampleInterval:50},initialize:function(a){g.dia.CellView.prototype.initialize.apply(this,arguments),"function"!=typeof this.constructor.prototype.watchSource&&(this.constructor.prototype.watchSource=this.createWatcher("source"),this.constructor.prototype.watchTarget=this.createWatcher("target")),this._labelCache={},this._markerCache={},this.startListening()},startListening:function(){var a=this.model;this.listenTo(a,"change:markup",this.render),this.listenTo(a,"change:smooth change:manhattan change:router change:connector",this.update),this.listenTo(a,"change:toolMarkup",this.onToolsChange),this.listenTo(a,"change:labels change:labelMarkup",this.onLabelsChange),this.listenTo(a,"change:vertices change:vertexMarkup",this.onVerticesChange),this.listenTo(a,"change:source",this.onSourceChange),this.listenTo(a,"change:target",this.onTargetChange)},onSourceChange:function(a,b){this.watchSource(a,b).update()},onTargetChange:function(a,b){this.watchTarget(a,b).update()},onVerticesChange:function(a,b,c){this.renderVertexMarkers(),(!c.translateBy||c.translateBy===this.model.id||this.model.hasLoop())&&this.update()},onToolsChange:function(){this.renderTools().updateToolsPosition()},onLabelsChange:function(){this.renderLabels().updateLabelPositions()},render:function(){this.$el.empty();var a=f(this.model.get("markup")||this.model.markup);if(c.isArray(a)||(a=[a]),this._V={},c.each(a,function(a){var b=a.attr("class");b&&(this._V[d.camelCase(b)]=a)},this),!this._V.connection)throw new Error("link: no connection path in the markup");return this.renderTools(),this.renderVertexMarkers(),this.renderArrowheadMarkers(),this.vel.append(a),this.renderLabels(),this.watchSource(this.model,this.model.get("source")).watchTarget(this.model,this.model.get("target")).update(),this},renderLabels:function(){if(!this._V.labels)return this;this._labelCache={};var a=d(this._V.labels.node).empty(),b=this.model.get("labels")||[];if(!b.length)return this;var e=c.template(this.model.get("labelMarkup")||this.model.labelMarkup),h=f(e()),i=this.can("labelMove");return c.each(b,function(b,e){var j=h.clone().node;f(j).attr("label-idx",e),i&&f(j).attr("cursor","move"),this._labelCache[e]=f(j);var k=d(j).find("text"),l=d(j).find("rect"),m=c.extend({"text-anchor":"middle","font-size":14},g.util.getByPath(b,"attrs/text","/"));k.attr(c.omit(m,"text")),c.isUndefined(m.text)||f(k[0]).text(m.text+""),a.append(j);var n=f(k[0]).bbox(!0,a[0]);f(k[0]).translate(0,-n.height/2);var o=c.extend({fill:"white",rx:3,ry:3},g.util.getByPath(b,"attrs/rect","/"));l.attr(c.extend(o,{x:n.x,y:n.y-n.height/2,width:n.width,height:n.height}))},this),this},renderTools:function(){if(!this._V.linkTools)return this;var a=d(this._V.linkTools.node).empty(),b=c.template(this.model.get("toolMarkup")||this.model.toolMarkup),e=f(b());if(a.append(e.node),this._toolCache=e,this.options.doubleLinkTools){var g=e.clone();a.append(g.node),this._tool2Cache=g}return this},renderVertexMarkers:function(){if(!this._V.markerVertices)return this;var a=d(this._V.markerVertices.node).empty(),b=c.template(this.model.get("vertexMarkup")||this.model.vertexMarkup);return c.each(this.model.get("vertices"),function(d,e){a.append(f(b(c.extend({idx:e},d))).node)}),this},renderArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;var a=d(this._V.markerArrowheads.node);a.empty();var b=c.template(this.model.get("arrowheadMarkup")||this.model.arrowheadMarkup);return this._V.sourceArrowhead=f(b({end:"source"})),this._V.targetArrowhead=f(b({end:"target"})),a.append(this._V.sourceArrowhead.node,this._V.targetArrowhead.node),this},update:function(){c.each(this.model.get("attrs"),function(a,b){var d=[];c.isObject(a.fill)&&(this.applyGradient(b,"fill",a.fill),d.push("fill")),c.isObject(a.stroke)&&(this.applyGradient(b,"stroke",a.stroke),d.push("stroke")),c.isObject(a.filter)&&(this.applyFilter(b,a.filter),d.push("filter")),d.length>0&&(d.unshift(a),a=c.omit.apply(c,d)),this.findBySelector(b).attr(a)},this);var a=this.route=this.findRoute(this.model.get("vertices")||[]);this._findConnectionPoints(a);var b=this.getPathData(a);return this._V.connection.attr("d",b),this._V.connectionWrap&&this._V.connectionWrap.attr("d",b),this._translateAndAutoOrientArrows(this._V.markerSource,this._V.markerTarget),this.updateLabelPositions(),this.updateToolsPosition(),this.updateArrowheadMarkers(),delete this.options.perpendicular,this.updatePostponed=!1,this},_findConnectionPoints:function(a){var b,d,f,g,h=c.first(a);b=this.getConnectionPoint("source",this.model.get("source"),h||this.model.get("target")).round();var i=c.last(a);d=this.getConnectionPoint("target",this.model.get("target"),i||b).round();var j=this._markerCache;this._V.markerSource&&(j.sourceBBox=j.sourceBBox||this._V.markerSource.bbox(!0),f=e.point(b).move(h||d,j.sourceBBox.width*this._V.markerSource.scale().sx*-1).round()),this._V.markerTarget&&(j.targetBBox=j.targetBBox||this._V.markerTarget.bbox(!0),g=e.point(d).move(i||b,j.targetBBox.width*this._V.markerTarget.scale().sx*-1).round()),j.sourcePoint=f||b,j.targetPoint=g||d,this.sourcePoint=b,this.targetPoint=d},updateLabelPositions:function(){if(!this._V.labels)return this;var a=this.model.get("labels")||[];if(!a.length)return this;var b=this._V.connection.node,d=b.getTotalLength();if(!c.isNaN(d)){var f;c.each(a,function(a,g){var h=a.position,i=c.isObject(h)?h.distance:h,j=c.isObject(h)?h.offset:{x:0,y:0};i=i>d?d:i,i=0>i?d+i:i,i=i>1?i:d*i;var k=b.getPointAtLength(i);if(c.isObject(j))k=e.point(k).offset(j.x,j.y);else if(c.isNumber(j)){f||(f=this._samples||this._V.connection.sample(this.options.sampleInterval));for(var l,m,n,o,p=1/0,q=0,r=f.length;r>q;q++)n=f[q],o=e.line(n,k).squaredLength(),p>o&&(p=o,l=n,m=q);var s=f[m-1],t=f[m+1],u=0;t?u=e.point(k).theta(t):s&&(u=e.point(s).theta(k)),k=e.point(k).offset(j).rotate(k,u-90)}this._labelCache[g].attr("transform","translate("+k.x+", "+k.y+")")},this)}return this},updateToolsPosition:function(){if(!this._V.linkTools)return this;var a="",b=this.options.linkToolsOffset,d=this.getConnectionLength();if(!c.isNaN(d)){d<this.options.shortLinkLength&&(a="scale(.5)",b/=2);var e=this.getPointAtLength(b);if(this._toolCache.attr("transform","translate("+e.x+", "+e.y+") "+a),this.options.doubleLinkTools&&d>=this.options.longLinkLength){var f=this.options.doubleLinkToolsOffset||b;e=this.getPointAtLength(d-f),this._tool2Cache.attr("transform","translate("+e.x+", "+e.y+") "+a),this._tool2Cache.attr("visibility","visible")}else this.options.doubleLinkTools&&this._tool2Cache.attr("visibility","hidden")}return this},updateArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;if("none"===d.css(this._V.markerArrowheads.node,"display"))return this;var a=this.getConnectionLength()<this.options.shortLinkLength?.5:1;return this._V.sourceArrowhead.scale(a),this._V.targetArrowhead.scale(a),this._translateAndAutoOrientArrows(this._V.sourceArrowhead,this._V.targetArrowhead),this},createWatcher:function(a){function b(b,c){c=c||{};var e=null,f=b.previous(a)||{};return f.id&&this.stopListening(this.paper.getModelById(f.id),"change",d),c.id&&(e=this.paper.getModelById(c.id),this.listenTo(e,"change",d)),d.call(this,e,{cacheOnly:!0}),this}var d=c.partial(this.onEndModelChange,a);return b},onEndModelChange:function(a,b,d){var f=!d.cacheOnly,g=this.model.get(a)||{};if(b){var h=this.constructor.makeSelector(g),i="source"==a?"target":"source",j=this.model.get(i)||{},k=j.id&&this.constructor.makeSelector(j);if(d.handleBy===this.cid&&h==k)this[a+"BBox"]=this[i+"BBox"],this[a+"View"]=this[i+"View"],this[a+"Magnet"]=this[i+"Magnet"];else if(d.translateBy){var l=this[a+"BBox"];l.x+=d.tx,l.y+=d.ty}else{var m=this.paper.findViewByModel(g.id),n=m.el.querySelector(h);this[a+"BBox"]=m.getStrokeBBox(n),this[a+"View"]=m,this[a+"Magnet"]=n}if(d.handleBy===this.cid&&d.translateBy&&this.model.isEmbeddedIn(b)&&!c.isEmpty(this.model.get("vertices"))&&(f=!1),!this.updatePostponed&&j.id){var o=this.paper.getModelById(j.id);g.id===j.id&&(d.handleBy=this.cid),(d.handleBy===this.cid||d.translateBy&&o.isEmbeddedIn(d.translateBy))&&(this.updatePostponed=!0,f=!1)}}else this[a+"BBox"]=e.rect(g.x||0,g.y||0,1,1),this[a+"View"]=this[a+"Magnet"]=null;this.lastEndChange=a,f&&this.update()},_translateAndAutoOrientArrows:function(a,b){a&&a.translateAndAutoOrient(this.sourcePoint,c.first(this.route)||this.targetPoint,this.paper.viewport),b&&b.translateAndAutoOrient(this.targetPoint,c.last(this.route)||this.sourcePoint,this.paper.viewport)},removeVertex:function(a){var b=c.clone(this.model.get("vertices"));return b&&b.length&&(b.splice(a,1),this.model.set("vertices",b,{ui:!0})),this},addVertex:function(a){for(var b,c=(this.model.get("vertices")||[]).slice(),d=c.slice(),e=this._V.connection.node.cloneNode(!1),g=e.getTotalLength(),h=20,i=c.length+1;i--&&(c.splice(i,0,a),f(e).attr("d",this.getPathData(this.findRoute(c))),b=e.getTotalLength(),b-g>h);)c=d.slice();return-1===i&&(i=0,c.splice(i,0,a)),this.model.set("vertices",c,{ui:!0}),i},sendToken:function(a,b,d){b=b||1e3,f(this.paper.viewport).append(a),f(a).animateAlongPath({dur:b+"ms",repeatCount:1},this._V.connection.node),c.delay(function(){f(a).remove(),d&&d()},b)},findRoute:function(a){var b=this.model.get("router");if(!b){if(!this.model.get("manhattan"))return a;b={name:"orthogonal"}}var d=g.routers[b.name];if(!c.isFunction(d))throw"unknown router: "+b.name;var e=d.call(this,a||[],b.args||{},this);return e},getPathData:function(a){var b=this.model.get("connector");if(b||(b=this.model.get("smooth")?{name:"smooth"}:{name:"normal"}),!c.isFunction(g.connectors[b.name]))throw"unknown connector: "+b.name;var d=g.connectors[b.name].call(this,this._markerCache.sourcePoint,this._markerCache.targetPoint,a||this.model.get("vertices")||{},b.args||{},this);return d},getConnectionPoint:function(a,b,d){var f;if(c.isEmpty(b)&&(b={x:0,y:0}),c.isEmpty(d)&&(d={x:0,y:0}),b.id){var g,h="source"===a?this.sourceBBox:this.targetBBox;if(d.id){var i="source"===a?this.targetBBox:this.sourceBBox;g=e.rect(i).intersectionWithLineFromCenterToPoint(e.rect(h).center()),g=g||e.rect(i).center()}else g=e.point(d);if(this.paper.options.perpendicularLinks||this.options.perpendicular){var j,k=e.rect(0,g.y,this.paper.options.width,1),l=e.rect(g.x,0,1,this.paper.options.height);if(k.intersect(e.rect(h)))switch(j=e.rect(h).sideNearestToPoint(g)){case"left":f=e.point(h.x,g.y);break;case"right":f=e.point(h.x+h.width,g.y);break;default:f=e.rect(h).center()}else if(l.intersect(e.rect(h)))switch(j=e.rect(h).sideNearestToPoint(g)){case"top":f=e.point(g.x,h.y);break;case"bottom":f=e.point(g.x,h.y+h.height);break;default:f=e.rect(h).center()}else f=e.rect(h).intersectionWithLineFromCenterToPoint(g),f=f||e.rect(h).center()}else if(this.paper.options.linkConnectionPoint){var m="target"===a?this.targetView:this.sourceView,n="target"===a?this.targetMagnet:this.sourceMagnet;f=this.paper.options.linkConnectionPoint(this,m,n,g)}else f=e.rect(h).intersectionWithLineFromCenterToPoint(g),f=f||e.rect(h).center()}else f=e.point(b);return f},getConnectionLength:function(){return this._V.connection.node.getTotalLength()},getPointAtLength:function(a){return this._V.connection.node.getPointAtLength(a)},_beforeArrowheadMove:function(){this._z=this.model.get("z"),this.model.toFront(),this.el.style.pointerEvents="none",this.paper.options.markAvailable&&this._markAvailableMagnets()},_afterArrowheadMove:function(){this._z&&(this.model.set("z",this._z,{ui:!0}),delete this._z),this.el.style.pointerEvents="visiblePainted",this.paper.options.markAvailable&&this._unmarkAvailableMagnets()},_createValidateConnectionArgs:function(a){function b(a,b){return c[f]=a,c[f+1]=a.el===b?void 0:b,c}var c=[];c[4]=a,c[5]=this;var d,e=0,f=0;"source"===a?(e=2,d="target"):(f=2,d="source");var g=this.model.get(d);return g.id&&(c[e]=this.paper.findViewByModel(g.id),c[e+1]=g.selector&&c[e].el.querySelector(g.selector)),b},_markAvailableMagnets:function(){var a=this.paper.model.getElements(),b=this.paper.options.validateConnection;c.chain(a).map(this.paper.findViewByModel,this.paper).each(function(a){var d="false"!==a.el.getAttribute("magnet")&&b.apply(this.paper,this._validateConnectionArgs(a,null)),e=c.filter(a.el.querySelectorAll("[magnet]"),function(c){return b.apply(this.paper,this._validateConnectionArgs(a,c))},this);d&&f(a.el).addClass("available-magnet"),c.each(e,function(a){f(a).addClass("available-magnet")}),(d||e.length)&&f(a.el).addClass("available-cell")},this)},_unmarkAvailableMagnets:function(){c.each(this.paper.el.querySelectorAll(".available-cell, .available-magnet"),function(a){f(a).removeClass("available-magnet").removeClass("available-cell")})},startArrowheadMove:function(a){this._action="arrowhead-move",this._arrowhead=a,this._validateConnectionArgs=this._createValidateConnectionArgs(this._arrowhead),this._beforeArrowheadMove()},can:function(a){var b=c.isFunction(this.options.interactive)?this.options.interactive(this,"pointerdown"):this.options.interactive;return c.isObject(b)&&b[a]===!1?!1:!0},pointerdown:function(a,b,d){if(g.dia.CellView.prototype.pointerdown.apply(this,arguments),this.notify("link:pointerdown",a,b,d),this._dx=b,this._dy=d,null==a.target.getAttribute("magnet")){var e=c.isFunction(this.options.interactive)?this.options.interactive(this,"pointerdown"):this.options.interactive;if(e!==!1){var h,i=a.target.getAttribute("class"),j=a.target.parentNode.getAttribute("class");switch("label"===j?(i=j,h=a.target.parentNode):h=a.target,i){case"marker-vertex":this.can("vertexMove")&&(this._action="vertex-move",this._vertexIdx=a.target.getAttribute("idx"));break;case"marker-vertex-remove":case"marker-vertex-remove-area":this.can("vertexRemove")&&this.removeVertex(a.target.getAttribute("idx"));break;case"marker-arrowhead":this.can("arrowheadMove")&&this.startArrowheadMove(a.target.getAttribute("end"));break;case"label":this.can("labelMove")&&(this._action="label-move",this._labelIdx=parseInt(f(h).attr("label-idx"),10),this._samples=this._V.connection.sample(1),this._linkLength=this._V.connection.node.getTotalLength());break;default:var k=a.target.parentNode.getAttribute("event");k?"remove"===k?this.model.remove():this.paper.trigger(k,a,this,b,d):this.can("vertexAdd")&&(this._vertexIdx=this.addVertex({x:b,y:d}),this._action="vertex-move")}}}},pointermove:function(a,b,d){switch(this._action){case"vertex-move":var h=c.clone(this.model.get("vertices"));h[this._vertexIdx]={x:b,y:d},this.model.set("vertices",h,{ui:!0});break;case"label-move":for(var i,j,k,l,m={x:b,y:d},n=(this.model.get("labels")[this._labelIdx],this._samples),o=1/0,p=0,q=n.length;q>p;p++)k=n[p],l=e.line(k,m).squaredLength(),o>l&&(o=l,i=k,j=p);var r=n[j-1],s=n[j+1],t=(e.point(i).distance(m),0);r&&s?t=e.line(r,s).pointOffset(m):r?t=e.line(r,i).pointOffset(m):s&&(t=e.line(i,s).pointOffset(m)),this.model.label(this._labelIdx,{position:{distance:i.distance/this._linkLength,offset:t}});break;case"arrowhead-move":if(this.paper.options.snapLinks){var u=this.paper.options.snapLinks.radius||50,v=this.paper.findViewsInArea({x:b-u,y:d-u,width:2*u,height:2*u});this._closestView&&this._closestView.unhighlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this._closestView=this._closestEnd=null;var w,x=Number.MAX_VALUE,y=e.point(b,d);c.each(v,function(a){"false"!==a.el.getAttribute("magnet")&&(w=a.model.getBBox().center().distance(y),u>w&&x>w&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(a,null))&&(x=w,this._closestView=a,this._closestEnd={id:a.model.id})),a.$("[magnet]").each(c.bind(function(b,c){var d=f(c).bbox(!1,this.paper.viewport);w=y.distance({x:d.x+d.width/2,y:d.y+d.height/2}),u>w&&x>w&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(a,c))&&(x=w,this._closestView=a,this._closestEnd={id:a.model.id,selector:a.getSelector(c),port:c.getAttribute("port")})},this))},this),this._closestView&&this._closestView.highlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this.model.set(this._arrowhead,this._closestEnd||{x:b,y:d},{ui:!0})}else{var z="mousemove"===a.type?a.target:document.elementFromPoint(a.clientX,a.clientY);this._targetEvent!==z&&(this._magnetUnderPointer&&this._viewUnderPointer.unhighlight(this._magnetUnderPointer,{connecting:!0}),this._viewUnderPointer=this.paper.findView(z),this._viewUnderPointer?(this._magnetUnderPointer=this._viewUnderPointer.findMagnet(z),this._magnetUnderPointer&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(this._viewUnderPointer,this._magnetUnderPointer))?this._magnetUnderPointer&&this._viewUnderPointer.highlight(this._magnetUnderPointer,{connecting:!0}):this._magnetUnderPointer=null):this._magnetUnderPointer=null),this._targetEvent=z,this.model.set(this._arrowhead,{x:b,y:d},{ui:!0})}}this._dx=b,this._dy=d,g.dia.CellView.prototype.pointermove.apply(this,arguments),this.notify("link:pointermove",a,b,d)},pointerup:function(a,b,c){"label-move"===this._action?this._samples=null:"arrowhead-move"===this._action&&(this.paper.options.snapLinks?(this._closestView&&this._closestView.unhighlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this._closestView=this._closestEnd=null):(this._magnetUnderPointer&&(this._viewUnderPointer.unhighlight(this._magnetUnderPointer,{connecting:!0}),this.model.set(this._arrowhead,{id:this._viewUnderPointer.model.id,selector:this._viewUnderPointer.getSelector(this._magnetUnderPointer),port:d(this._magnetUnderPointer).attr("port")},{ui:!0})),delete this._viewUnderPointer,delete this._magnetUnderPointer),this.paper.options.embeddingMode&&this.model.reparent()&&delete this._z,this._afterArrowheadMove()),delete this._action,this.notify("link:pointerup",a,b,c),g.dia.CellView.prototype.pointerup.apply(this,arguments)}},{makeSelector:function(a){var b='[model-id="'+a.id+'"]';return a.port?b+=' [port="'+a.port+'"]':a.selector&&(b+=" "+a.selector),b}}),g.dia.Paper=b.View.extend({className:"paper",options:{width:800,height:600,origin:{x:0,y:0},gridSize:50,perpendicularLinks:!1,elementView:g.dia.ElementView,linkView:g.dia.LinkView,snapLinks:!1,markAvailable:!1,defaultLink:new g.dia.Link,validateMagnet:function(a,b){return"passive"!==b.getAttribute("magnet")},validateConnection:function(a,b,c,d,e,f){return("target"===e?c:a)instanceof g.dia.ElementView},embeddingMode:!1,validateEmbedding:function(a,b){return!0},findParentBy:"bbox",frontParentOnly:!0,interactive:{labelMove:!1}},events:{mousedown:"pointerdown",dblclick:"mousedblclick",click:"mouseclick",touchstart:"pointerdown",mousemove:"pointermove",touchmove:"pointermove","mouseover .element":"cellMouseover","mouseover .link":"cellMouseover","mouseout .element":"cellMouseout","mouseout .link":"cellMouseout",contextmenu:"contextmenu"},constructor:function(a){this._configure(a),b.View.apply(this,arguments)},_configure:function(a){this.options&&(a=c.extend({},c.result(this,"options"),a)),this.options=a},initialize:function(){c.bindAll(this,"addCell","sortCells","resetCells","pointerup","asyncRenderCells"),this.svg=f("svg").node,this.viewport=f("g").addClass("viewport").node,this.defs=f("defs").node,f(this.svg).append([this.viewport,this.defs]),this.$el.append(this.svg),this.setOrigin(),this.setDimensions(),this.listenTo(this.model,"add",this.onAddCell),this.listenTo(this.model,"reset",this.resetCells),this.listenTo(this.model,"sort",this.sortCells),d(document).on("mouseup touchend",this.pointerup),this._mousemoved=!1,this.on({"cell:highlight":this.onCellHighlight,"cell:unhighlight":this.onCellUnhighlight})},remove:function(){this.removeCells(),d(document).off("mouseup touchend",this.pointerup),b.View.prototype.remove.call(this)},setDimensions:function(a,b){a=this.options.width=a||this.options.width,b=this.options.height=b||this.options.height,f(this.svg).attr({width:a,height:b}),this.trigger("resize",a,b)},setOrigin:function(a,b){this.options.origin.x=a||0,this.options.origin.y=b||0,f(this.viewport).translate(a,b,{absolute:!0}),this.trigger("translate",a,b)},fitToContent:function(a,b,d,e){c.isObject(a)?(e=a,a=e.gridWidth||1,b=e.gridHeight||1,d=e.padding||0):(e=e||{},a=a||1,b=b||1,d=d||0),d=g.util.normalizeSides(d);var h=f(this.viewport).bbox(!0,this.svg),i=f(this.viewport).scale();h.x*=i.sx,h.y*=i.sy,h.width*=i.sx,h.height*=i.sy;var j=Math.max(Math.ceil((h.width+h.x)/a),1)*a,k=Math.max(Math.ceil((h.height+h.y)/b),1)*b,l=0,m=0;("negative"==e.allowNewOrigin&&h.x<0||"positive"==e.allowNewOrigin&&h.x>=0||"any"==e.allowNewOrigin)&&(l=Math.ceil(-h.x/a)*a,l+=d.left,j+=l),("negative"==e.allowNewOrigin&&h.y<0||"positive"==e.allowNewOrigin&&h.y>=0||"any"==e.allowNewOrigin)&&(m=Math.ceil(-h.y/b)*b,
m+=d.top,k+=m),j+=d.right,k+=d.bottom,j=Math.max(j,e.minWidth||0),k=Math.max(k,e.minHeight||0),j=Math.min(j,e.maxWidth||Number.MAX_VALUE),k=Math.min(k,e.maxHeight||Number.MAX_VALUE);var n=j!=this.options.width||k!=this.options.height,o=l!=this.options.origin.x||m!=this.options.origin.y;o&&this.setOrigin(l,m),n&&this.setDimensions(j,k)},scaleContentToFit:function(a){var b=this.getContentBBox();if(b.width&&b.height){a=a||{},c.defaults(a,{padding:0,preserveAspectRatio:!0,scaleGrid:null,minScale:0,maxScale:Number.MAX_VALUE});var d=a.padding,g=a.minScaleX||a.minScale,h=a.maxScaleX||a.maxScale,i=a.minScaleY||a.minScale,j=a.maxScaleY||a.maxScale,k=a.fittingBBox||{x:this.options.origin.x,y:this.options.origin.y,width:this.options.width,height:this.options.height};k=e.rect(k).moveAndExpand({x:d,y:d,width:-2*d,height:-2*d});var l=f(this.viewport).scale(),m=k.width/b.width*l.sx,n=k.height/b.height*l.sy;if(a.preserveAspectRatio&&(m=n=Math.min(m,n)),a.scaleGrid){var o=a.scaleGrid;m=o*Math.floor(m/o),n=o*Math.floor(n/o)}m=Math.min(h,Math.max(g,m)),n=Math.min(j,Math.max(i,n)),this.scale(m,n);var p=this.getContentBBox(),q=k.x-p.x,r=k.y-p.y;this.setOrigin(q,r)}},getContentBBox:function(){var a=this.viewport.getBoundingClientRect(),b=this.viewport.getScreenCTM(),c=this.viewport.getCTM(),d=e.rect({x:a.left-b.e+c.e,y:a.top-b.f+c.f,width:a.width,height:a.height});return d},createViewForModel:function(a){var b,c=a.get("type"),d=c.split(".")[0],e=c.split(".")[1];return b=g.shapes[d]&&g.shapes[d][e+"View"]?new g.shapes[d][e+"View"]({model:a,interactive:this.options.interactive}):a instanceof g.dia.Element?new this.options.elementView({model:a,interactive:this.options.interactive}):new this.options.linkView({model:a,interactive:this.options.interactive})},onAddCell:function(a,b,d){if(this.options.async&&d.async!==!1&&c.isNumber(d.position)){if(this._asyncCells=this._asyncCells||[],this._asyncCells.push(a),0==d.position){if(this._frameId)throw"another asynchronous rendering in progress";this.asyncRenderCells(this._asyncCells),delete this._asyncCells}}else this.addCell(a)},addCell:function(a){var b=this.createViewForModel(a);f(this.viewport).append(b.el),b.paper=this,b.render(),d(b.el).find("image").on("dragstart",function(){return!1})},beforeRenderCells:function(a){return a.sort(function(a,b){return a instanceof g.dia.Link?1:-1}),a},afterRenderCells:function(){this.sortCells()},resetCells:function(a,b){d(this.viewport).empty();var e=a.models.slice();e=this.beforeRenderCells(e,b),this._frameId&&(g.util.cancelFrame(this._frameId),delete this._frameId),this.options.async?this.asyncRenderCells(e,b):(c.each(e,this.addCell,this),this.sortCells())},removeCells:function(){this.model.get("cells").each(function(a){var b=this.findViewByModel(a);b&&b.remove()},this)},asyncBatchAdded:c.identity,asyncRenderCells:function(a,b){var d=!1;this._frameId&&(c.each(c.range(this.options.async&&this.options.async.batchSize||50),function(){var b=a.shift();d=!b,d||this.addCell(b)},this),this.asyncBatchAdded()),d?(delete this._frameId,this.afterRenderCells(b),this.trigger("render:done",b)):this._frameId=g.util.nextFrame(c.bind(function(){this.asyncRenderCells(a,b)},this))},sortCells:function(){var a=d(this.viewport).children("[model-id]"),b=this.model.get("cells");g.util.sortElements(a,function(a,c){var e=b.get(d(a).attr("model-id")),f=b.get(d(c).attr("model-id"));return(e.get("z")||0)>(f.get("z")||0)?1:-1})},scale:function(a,b,d,e){b=b||a,c.isUndefined(d)&&(d=0,e=0),f(this.viewport).attr("transform","");var g=this.options.origin.x,h=this.options.origin.y;if(d||e||g||h){var i=g-d*(a-1),j=h-e*(b-1);this.setOrigin(i,j)}return f(this.viewport).scale(a,b),this.trigger("scale",a,b,d,e),this},rotate:function(a,b,d){if(c.isUndefined(b)){var e=this.viewport.getBBox();b=e.width/2,d=e.height/2}f(this.viewport).rotate(a,b,d)},findView:function(a){var b=this.$(a);return 0===b.length||b[0]===this.el?void 0:b.data("view")||this.findView(b.parent())},findViewByModel:function(a){var b=c.isString(a)?a:a.id,d=this.$('[model-id="'+b+'"]');return d.length?d.data("view"):void 0},findViewsFromPoint:function(a){a=e.point(a);var b=c.map(this.model.getElements(),this.findViewByModel);return c.filter(b,function(b){return b&&e.rect(f(b.el).bbox(!1,this.viewport)).containsPoint(a)},this)},findViewsInArea:function(a){a=e.rect(a);var b=c.map(this.model.getElements(),this.findViewByModel);return c.filter(b,function(b){return b&&a.intersect(e.rect(f(b.el).bbox(!1,this.viewport)))},this)},getModelById:function(a){return this.model.getCell(a)},snapToGrid:function(a){var b=f(this.viewport).toLocalPoint(a.x,a.y);return{x:e.snapToGrid(b.x,this.options.gridSize),y:e.snapToGrid(b.y,this.options.gridSize)}},clientToLocalPoint:function(a){var b=this.svg.createSVGPoint();b.x=a.x,b.y=a.y;var c=f("rect",{width:this.options.width,height:this.options.height,x:0,y:0,opacity:0});f(this.svg).prepend(c);var e=d(this.svg).offset();c.remove();var g=document.body.scrollTop||document.documentElement.scrollTop,h=document.body.scrollLeft||document.documentElement.scrollLeft;b.x+=h-e.left,b.y+=g-e.top;var i=b.matrixTransform(this.viewport.getCTM().inverse());return i},getDefaultLink:function(a,b){return c.isFunction(this.options.defaultLink)?this.options.defaultLink.call(this,a,b):this.options.defaultLink.clone()},onCellHighlight:function(a,b){f(b).addClass("highlighted")},onCellUnhighlight:function(a,b){f(b).removeClass("highlighted")},mousedblclick:function(a){a.preventDefault(),a=g.util.normalizeEvent(a);var b=this.findView(a.target);if(!this.guard(a,b)){var c=this.snapToGrid({x:a.clientX,y:a.clientY});b?b.pointerdblclick(a,c.x,c.y):this.trigger("blank:pointerdblclick",a,c.x,c.y)}},mouseclick:function(a){if(!this._mousemoved){a=g.util.normalizeEvent(a);var b=this.findView(a.target);if(this.guard(a,b))return;var c=this.snapToGrid({x:a.clientX,y:a.clientY});b?b.pointerclick(a,c.x,c.y):this.trigger("blank:pointerclick",a,c.x,c.y)}this._mousemoved=!1},guard:function(a,b){return b&&b.model&&b.model instanceof g.dia.Cell?!1:this.svg===a.target||this.el===a.target||d.contains(this.svg,a.target)?!1:!0},contextmenu:function(a){a=g.util.normalizeEvent(a);var b=this.findView(a.target);if(!this.guard(a,b)){var c=this.snapToGrid({x:a.clientX,y:a.clientY});b?b.contextmenu(a,c.x,c.y):this.trigger("blank:contextmenu",a,c.x,c.y)}},pointerdown:function(a){a=g.util.normalizeEvent(a);var b=this.findView(a.target);if(!this.guard(a,b)){var c=this.snapToGrid({x:a.clientX,y:a.clientY});b?(this.sourceView=b,b.pointerdown(a,c.x,c.y)):this.trigger("blank:pointerdown",a,c.x,c.y)}},pointermove:function(a){if(a.preventDefault(),a=g.util.normalizeEvent(a),this.sourceView){this._mousemoved=!0;var b=this.snapToGrid({x:a.clientX,y:a.clientY});this.sourceView.pointermove(a,b.x,b.y)}},pointerup:function(a){a=g.util.normalizeEvent(a);var b=this.snapToGrid({x:a.clientX,y:a.clientY});this.sourceView?(this.sourceView.pointerup(a,b.x,b.y),this.sourceView=null):this.trigger("blank:pointerup",a,b.x,b.y)},cellMouseover:function(a){a=g.util.normalizeEvent(a);var b=this.findView(a.target);if(b){if(this.guard(a,b))return;b.mouseover(a)}},cellMouseout:function(a){a=g.util.normalizeEvent(a);var b=this.findView(a.target);if(b){if(this.guard(a,b))return;b.mouseout(a)}}}),g.shapes.basic={},g.shapes.basic.Generic=g.dia.Element.extend({defaults:g.util.deepSupplement({type:"basic.Generic",attrs:{".":{fill:"#ffffff",stroke:"none"}}},g.dia.Element.prototype.defaults)}),g.shapes.basic.Rect=g.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><rect/></g><text/></g>',defaults:g.util.deepSupplement({type:"basic.Rect",attrs:{rect:{fill:"#ffffff",stroke:"#000000",width:100,height:60},text:{fill:"#000000",text:"","font-size":14,"ref-x":.5,"ref-y":.5,"text-anchor":"middle","y-alignment":"middle","font-family":"Arial, helvetica, sans-serif"}}},g.shapes.basic.Generic.prototype.defaults)}),g.shapes.basic.TextView=g.dia.ElementView.extend({initialize:function(){g.dia.ElementView.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:attrs",this.resize)}}),g.shapes.basic.Text=g.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><text/></g></g>',defaults:g.util.deepSupplement({type:"basic.Text",attrs:{text:{"font-size":18,fill:"#000000"}}},g.shapes.basic.Generic.prototype.defaults)}),g.shapes.basic.Circle=g.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><circle/></g><text/></g>',defaults:g.util.deepSupplement({type:"basic.Circle",size:{width:60,height:60},attrs:{circle:{fill:"#ffffff",stroke:"#000000",r:30,cx:30,cy:30},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-y":.5,"y-alignment":"middle",fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},g.shapes.basic.Generic.prototype.defaults)}),g.shapes.basic.Ellipse=g.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><ellipse/></g><text/></g>',defaults:g.util.deepSupplement({type:"basic.Ellipse",size:{width:60,height:40},attrs:{ellipse:{fill:"#ffffff",stroke:"#000000",rx:30,ry:20,cx:30,cy:20},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-y":.5,"y-alignment":"middle",fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},g.shapes.basic.Generic.prototype.defaults)}),g.shapes.basic.Polygon=g.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><polygon/></g><text/></g>',defaults:g.util.deepSupplement({type:"basic.Polygon",size:{width:60,height:40},attrs:{polygon:{fill:"#ffffff",stroke:"#000000"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-dy":20,"y-alignment":"middle",fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},g.shapes.basic.Generic.prototype.defaults)}),g.shapes.basic.Polyline=g.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><polyline/></g><text/></g>',defaults:g.util.deepSupplement({type:"basic.Polyline",size:{width:60,height:40},attrs:{polyline:{fill:"#ffffff",stroke:"#000000"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-dy":20,"y-alignment":"middle",fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},g.shapes.basic.Generic.prototype.defaults)}),g.shapes.basic.Image=g.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><image/></g><text/></g>',defaults:g.util.deepSupplement({type:"basic.Image",attrs:{text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-dy":20,"y-alignment":"middle",fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},g.shapes.basic.Generic.prototype.defaults)}),g.shapes.basic.Path=g.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><path/></g><text/></g>',defaults:g.util.deepSupplement({type:"basic.Path",size:{width:60,height:60},attrs:{path:{fill:"#ffffff",stroke:"#000000"},text:{"font-size":14,text:"","text-anchor":"middle",ref:"path","ref-x":.5,"ref-dy":10,fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},g.shapes.basic.Generic.prototype.defaults)}),g.shapes.basic.Rhombus=g.shapes.basic.Path.extend({defaults:g.util.deepSupplement({type:"basic.Rhombus",attrs:{path:{d:"M 30 0 L 60 30 30 60 0 30 z"},text:{"ref-y":.5,"y-alignment":"middle"}}},g.shapes.basic.Path.prototype.defaults)}),g.shapes.basic.PortsModelInterface={initialize:function(){this.updatePortsAttrs(),this.on("change:inPorts change:outPorts",this.updatePortsAttrs,this),this.constructor.__super__.constructor.__super__.initialize.apply(this,arguments)},updatePortsAttrs:function(a){var b=this.get("attrs");c.each(this._portSelectors,function(a){b[a]&&delete b[a]}),this._portSelectors=[];var d={};c.each(this.get("inPorts"),function(a,b,e){var f=this.getPortAttrs(a,b,e.length,".inPorts","in");this._portSelectors=this._portSelectors.concat(c.keys(f)),c.extend(d,f)},this),c.each(this.get("outPorts"),function(a,b,e){var f=this.getPortAttrs(a,b,e.length,".outPorts","out");this._portSelectors=this._portSelectors.concat(c.keys(f)),c.extend(d,f)},this),this.attr(d,{silent:!0}),this.processPorts(),this.trigger("process:ports")},getPortSelector:function(a){var b=".inPorts",c=this.get("inPorts").indexOf(a);if(0>c&&(b=".outPorts",c=this.get("outPorts").indexOf(a),0>c))throw new Error("getPortSelector(): Port doesn't exist.");return b+">g:nth-child("+(c+1)+")>circle"}},g.shapes.basic.PortsViewInterface={initialize:function(){this.listenTo(this.model,"process:ports",this.update),g.dia.ElementView.prototype.initialize.apply(this,arguments)},update:function(){this.renderPorts(),g.dia.ElementView.prototype.update.apply(this,arguments)},renderPorts:function(){var a=this.$(".inPorts").empty(),b=this.$(".outPorts").empty(),d=c.template(this.model.portMarkup);c.each(c.filter(this.model.ports,function(a){return"in"===a.type}),function(b,c){a.append(f(d({id:c,port:b})).node)}),c.each(c.filter(this.model.ports,function(a){return"out"===a.type}),function(a,c){b.append(f(d({id:c,port:a})).node)})}},g.shapes.basic.TextBlock=g.shapes.basic.Generic.extend({markup:['<g class="rotatable"><g class="scalable"><rect/></g><switch>','<foreignObject requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" class="fobj">','<body xmlns="http://www.w3.org/1999/xhtml"><div/></body>',"</foreignObject>",'<text class="content"/>',"</switch></g>"].join(""),defaults:g.util.deepSupplement({type:"basic.TextBlock",attrs:{rect:{fill:"#ffffff",stroke:"#000000",width:80,height:100},text:{fill:"#000000","font-size":14,"font-family":"Arial, helvetica, sans-serif"},".content":{text:"",ref:"rect","ref-x":.5,"ref-y":.5,"y-alignment":"middle","x-alignment":"middle"}},content:""},g.shapes.basic.Generic.prototype.defaults),initialize:function(){"undefined"!=typeof SVGForeignObjectElement&&(this.setForeignObjectSize(this,this.get("size")),this.setDivContent(this,this.get("content")),this.listenTo(this,"change:size",this.setForeignObjectSize),this.listenTo(this,"change:content",this.setDivContent)),g.shapes.basic.Generic.prototype.initialize.apply(this,arguments)},setForeignObjectSize:function(a,b){a.attr({".fobj":c.clone(b),div:{style:c.clone(b)}})},setDivContent:function(a,b){a.attr({div:{html:b}})}}),g.shapes.basic.TextBlockView=g.dia.ElementView.extend({initialize:function(){g.dia.ElementView.prototype.initialize.apply(this,arguments),"undefined"==typeof SVGForeignObjectElement&&(this.noSVGForeignObjectElement=!0,this.listenTo(this.model,"change:content",function(a){this.updateContent(a)}))},update:function(a,b){if(this.noSVGForeignObjectElement){var d=this.model,e=c.omit(b||d.get("attrs"),".content");g.dia.ElementView.prototype.update.call(this,d,e),(!b||c.has(b,".content"))&&this.updateContent(d,b)}else g.dia.ElementView.prototype.update.call(this,d,b)},updateContent:function(a,b){var d=c.merge({},(b||a.get("attrs"))[".content"]);delete d.text;var e=g.util.breakText(a.get("content"),a.get("size"),d,{svgDocument:this.paper.svg}),f=g.util.setByPath({},".content",d,"/");f[".content"].text=e,g.dia.ElementView.prototype.update.call(this,a,f)}}),g.routers.orthogonal=function(){function a(a,b){return a.x==b.x?a.y>b.y?"N":"S":a.y==b.y?a.x>b.x?"W":"E":null}function b(a,b){return a["W"==b||"E"==b?"width":"height"]}function d(a,b){return e.rect(a).moveAndExpand({x:-b,y:-b,width:2*b,height:2*b})}function f(a){return e.rect(a.x,a.y,0,0)}function g(a,b){var c=Math.min(a.x,b.x),d=Math.min(a.y,b.y),f=Math.max(a.x+a.width,b.x+b.width),g=Math.max(a.y+a.height,b.y+b.height);return e.rect(c,d,f-c,g-d)}function h(a,b,c){var d=e.point(a.x,b.y);return c.containsPoint(d)&&(d=e.point(b.x,a.y)),d}function i(b,c,d){var f=e.point(b.x,c.y),g=e.point(c.x,b.y),h=a(b,f),i=a(b,g),j=o[d],k=h==d||h!=j&&(i==j||i!=d)?f:g;return{points:[k],direction:a(k,c)}}function j(b,c,d){var e=h(b,c,d);return{points:[e],direction:a(e,c)}}function k(d,f,g,i){var j,k={},l=[e.point(d.x,f.y),e.point(f.x,d.y)],m=c.filter(l,function(a){return!g.containsPoint(a)}),n=c.filter(m,function(b){return a(b,d)!=i});if(n.length>0)j=c.filter(n,function(b){return a(d,b)==i}).pop(),j=j||n[0],k.points=[j],k.direction=a(j,f);else{j=c.difference(l,m)[0];var o=e.point(f).move(j,-b(g,i)/2),p=h(o,d,g);k.points=[p,o],k.direction=a(o,f)}return k}function l(c,d,f,g){var h=j(d,c,g),k=h.points[0];if(f.containsPoint(k)){h=j(c,d,f);var l=h.points[0];if(g.containsPoint(l)){var m=e.point(c).move(l,-b(f,a(c,l))/2),n=e.point(d).move(k,-b(g,a(d,k))/2),o=e.line(m,n).midpoint(),p=j(c,o,f),q=i(o,d,p.direction);h.points=[p.points[0],q.points[0]],h.direction=q.direction}}return h}function m(b,c,f,i,j){var k,l,m,n={},o=d(g(f,i),1),q=o.center().distance(c)>o.center().distance(b),r=q?c:b,s=q?b:c;return j?(k=e.point.fromPolar(o.width+o.height,p[j],r),k=o.pointNearestToPoint(k).move(k,-1)):k=o.pointNearestToPoint(r).move(r,1),l=h(k,s,o),k.round().equals(l.round())?(l=e.point.fromPolar(o.width+o.height,e.toRad(k.theta(r))+Math.PI/2,s),l=o.pointNearestToPoint(l).move(s,1).round(),m=h(k,l,o),n.points=q?[l,m,k]:[k,m,l]):n.points=q?[l,k]:[k,l],n.direction=q?a(k,c):a(l,c),n}function n(b,g,h){var n=g.elementPadding||20,o=[],p=d(h.sourceBBox,n),q=d(h.targetBBox,n);b=c.map(b,e.point),b.unshift(p.center()),b.push(q.center());for(var r,s=0,t=b.length-1;t>s;s++){var u=null,v=b[s],w=b[s+1],x=!!a(v,w);if(0==s)s+1==t?p.intersect(d(q,1))?u=m(v,w,p,q):x||(u=l(v,w,p,q)):p.containsPoint(w)?u=m(v,w,p,d(f(w),n)):x||(u=j(v,w,p));else if(s+1==t){var y=x&&a(w,v)==r;q.containsPoint(v)||y?u=m(v,w,d(f(v),n),q,r):x||(u=k(v,w,q,r))}else x||(u=i(v,w,r));u?(Array.prototype.push.apply(o,u.points),r=u.direction):r=a(v,w),t>s+1&&o.push(w)}return o}var o={N:"S",S:"N",E:"W",W:"E"},p={N:-Math.PI/2*3,S:-Math.PI/2,E:0,W:Math.PI};return n}(),g.routers.manhattan=function(){"use strict";function a(a,b){for(var c,d=[],e={x:0,y:0},f=b;c=a[f];){var g=c.difference(f);g.equals(e)||(d.unshift(f),e=g),f=c}return d.unshift(f),d}function b(a,b,d){var f=d.step,g=a.center(),h=c.chain(d.directionMap).pick(b).map(function(b){var c=b.x*a.width/2,d=b.y*a.height/2,h=e.point(g).offset(c,d).snapToGrid(f);return a.containsPoint(h)&&h.offset(b.x*f,b.y*f),h}).value();return h}function d(a,b,c){var d=360/c,e=Math.floor(a.theta(b)/d);return c-e}function f(f,g,h,i){var j=i.reversed?i.endDirections:i.startDirections,k=i.reversed?i.startDirections:i.endDirections,l=f instanceof e.rect?b(f,j,i):[f],m=g instanceof e.rect?b(g,k,i):[g],n=l.length>1?f.center():l[0],o=m.length>1?g.center():m[0],p=c.filter(m,function(a){var b=e.point(a).snapToGrid(i.mapGridSize).toString(),d=c.every(h[b],function(b){return!b.containsPoint(a)});return d});if(p.length)for(var q=i.step,r=i.penalties,s=c.chain(p).invoke("snapToGrid",q).min(function(a){return i.estimateCost(n,a)}).value(),t={},u={},v={},w=i.directions,x=w.length,y=x/2,z=i.previousDirIndexes||{},A={},B={},C=c.chain(l).invoke("snapToGrid",q).each(function(a){var b=a.toString();u[b]=0,v[b]=i.estimateCost(a,s),z[b]=z[b]||d(n,a,x),B[b]=!0}).map(function(a){return a.toString()}).sortBy(function(a){return v[a]}).value(),D=i.maximumLoops,E=i.maxAllowedDirectionChange;C.length&&D--;){var F=C[0],G=e.point(F);if(s.equals(G))return i.previousDirIndexes=c.pick(z,F),a(t,G);C.splice(0,1),B[N]=null,A[N]=!0;for(var H=z[F],I=u[F],J=0;x>J;J++){var K=Math.abs(J-H);if(K>y&&(K=x-K),!(K>E)){var L=w[J],M=e.point(G).offset(L.offsetX,L.offsetY),N=M.toString();if(!A[N]){var O=e.point(M).snapToGrid(i.mapGridSize).toString(),P=c.every(h[O],function(a){return!a.containsPoint(M)});if(P){var Q=c.has(B,N),R=I+L.cost;if((!Q||R<u[N])&&(t[N]=G,z[N]=J,u[N]=R,v[N]=R+i.estimateCost(M,s)+r[K],!Q)){var S=c.sortedIndex(C,N,function(a){return v[a]});C.splice(S,0,N),B[N]=!0}}}}}}return i.fallbackRoute(n,o,i)}function g(a,b){b.directions=c.result(b,"directions"),b.penalties=c.result(b,"penalties"),b.paddingBox=c.result(b,"paddingBox"),this.options.perpendicular=!!b.perpendicular;var d=b.reversed="source"===this.lastEndChange,g=e.rect(d?this.targetBBox:this.sourceBBox),h=e.rect(d?this.sourceBBox:this.targetBBox);g.moveAndExpand(b.paddingBox),h.moveAndExpand(b.paddingBox);var i=this.model,j=this.paper.model,k=c.chain(b.excludeEnds).map(i.get,i).pluck("id").map(j.getCell,j).value(),l=b.mapGridSize,m=[],n=i.get("source").id;if(void 0!==n){var o=j.getCell(n);void 0!==o&&(m=c.union(m,c.map(o.getAncestors(),"id")))}var p=i.get("target").id;if(void 0!==p){var q=j.getCell(p);void 0!==q&&(m=c.union(m,c.map(q.getAncestors(),"id")))}for(var r=c.chain(j.getElements()).difference(k).reject(function(a){return c.contains(b.excludeTypes,a.get("type"))||c.contains(m,a.id)}).invoke("getBBox").invoke("moveAndExpand",b.paddingBox).foldl(function(a,b){for(var c=b.origin().snapToGrid(l),d=b.corner().snapToGrid(l),e=c.x;e<=d.x;e+=l)for(var f=c.y;f<=d.y;f+=l){var g=e+"@"+f;a[g]=a[g]||[],a[g].push(b)}return a},{}).value(),s=[],t=c.map(a,e.point),u=g.center(),v=0,w=t.length;w>=v;v++){var x=null,y=z||g,z=t[v];if(!z){z=h;var A=!this.model.get("source").id||!this.model.get("target").id;if(A&&c.isFunction(b.draggingRoute)){var B=y instanceof e.rect?y.center():y;x=b.draggingRoute(B,z.origin(),b)}}x=x||f(y,z,r,b);var C=c.first(x);C&&C.equals(u)&&x.shift(),u=c.last(x)||u,s=s.concat(x)}return d?s.reverse():s}var h={step:10,perpendicular:!0,mapGridSize:100,excludeEnds:[],excludeTypes:["basic.Text"],maximumLoops:500,startDirections:["left","right","top","bottom"],endDirections:["left","right","top","bottom"],directionMap:{right:{x:1,y:0},bottom:{x:0,y:1},left:{x:-1,y:0},top:{x:0,y:-1}},maxAllowedDirectionChange:1,paddingBox:function(){var a=this.step;return{x:-a,y:-a,width:2*a,height:2*a}},directions:function(){var a=this.step;return[{offsetX:a,offsetY:0,cost:a},{offsetX:0,offsetY:a,cost:a},{offsetX:-a,offsetY:0,cost:a},{offsetX:0,offsetY:-a,cost:a}]},penalties:function(){return[0,this.step/2,this.step]},estimateCost:function(a,b){return a.manhattanDistance(b)},fallbackRoute:function(a,b,c){var d=c.prevDirIndexes||{},f=(d[a]||0)%2?e.point(a.x,b.y):e.point(b.x,a.y);return[f,b]},draggingRoute:null};return function(a,b,d){return g.call(d,a,c.extend({},h,b))}}(),g.routers.metro=function(){if(!c.isFunction(g.routers.manhattan))throw"Metro requires the manhattan router.";var a={diagonalCost:null,directions:function(){var a=this.step,b=this.diagonalCost||Math.ceil(Math.sqrt(a*a<<1));return[{offsetX:a,offsetY:0,cost:a},{offsetX:a,offsetY:a,cost:b},{offsetX:0,offsetY:a,cost:a},{offsetX:-a,offsetY:a,cost:b},{offsetX:-a,offsetY:0,cost:a},{offsetX:-a,offsetY:-a,cost:b},{offsetX:0,offsetY:-a,cost:a},{offsetX:a,offsetY:-a,cost:b}]},fallbackRoute:function(a,b,c){var d=a.theta(b),f={x:b.x,y:a.y},g={x:a.x,y:b.y};if(d%180>90){var h=f;f=g,g=h}var i=45>d%90?f:g,j=e.line(a,i),k=90*Math.ceil(d/90),l=e.point.fromPolar(j.squaredLength(),e.toRad(k+135),i),m=e.line(b,l),n=j.intersection(m);return n?[n.round(),b]:[b]}};return function(b,d,e){return g.routers.manhattan(b,c.extend({},a,d),e)}}(),g.connectors.normal=function(a,b,d){var e=["M",a.x,a.y];return c.each(d,function(a){e.push(a.x,a.y)}),e.push(b.x,b.y),e.join(" ")},g.connectors.rounded=function(a,b,d,f){var g,h,i,j,k,l,m=f.radius||10,n=["M",a.x,a.y];return c.each(d,function(c,f){k=d[f-1]||a,l=d[f+1]||b,i=j||e.point(c).distance(k)/2,j=e.point(c).distance(l)/2,g=e.point(c).move(k,-Math.min(m,i)).round(),h=e.point(c).move(l,-Math.min(m,j)).round(),n.push(g.x,g.y,"S",c.x,c.y,h.x,h.y,"L")}),n.push(b.x,b.y),n.join(" ")},g.connectors.smooth=function(a,b,c){var d;if(c.length)d=e.bezier.curveThroughPoints([a].concat(c).concat([b]));else{var f=a.x<b.x?b.x-(b.x-a.x)/2:a.x-(a.x-b.x)/2;d=["M",a.x,a.y,"C",f,a.y,f,b.y,b.x,b.y]}return d.join(" ")},g});