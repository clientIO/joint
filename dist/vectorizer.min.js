/*! JointJS v0.9.4 - JavaScript diagramming library  2015-07-23 


This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
!function(a,b){if("function"==typeof define&&define.amd)define("V",["g"],function(a){return b(a)});else if("object"==typeof exports){var c=require("./geometry");module.exports=b(c)}else{var c=a.g;a.Vectorizer=a.V=b(c)}}(this,function(a){function b(){var a=++v+"";return"v-"+a}function c(a){return Object(a)===Object(a)}function d(a){return"[object Array]"==Object.prototype.toString.call(a)}function e(a){var b='<svg xmlns="'+t.xmlns+'" xmlns:xlink="'+t.xlink+'" version="'+u+'">'+(a||"")+"</svg>",c=new DOMParser;return c.async=!1,c.parseFromString(b,"text/xml").documentElement}function f(a,b,c){var d,f;if(!a)return void 0;if("object"==typeof a)return new k(a);if(b=b||{},"svg"===a.toLowerCase())return new k(e());if("<"===a[0]){var h=e(a);if(h.childNodes.length>1){var i=[];for(d=0,f=h.childNodes.length;f>d;d++){var j=h.childNodes[d];i.push(new k(document.importNode(j,!0)))}return i}return new k(document.importNode(h.firstChild,!0))}a=document.createElementNS(t.xmlns,a);for(var l in b)g(a,l,b[l]);for("[object Array]"!=Object.prototype.toString.call(c)&&(c=[c]),d=0,f=c[0]&&c.length||0;f>d;d++){var m=c[d];a.appendChild(m instanceof k?m.node:m)}return new k(a)}function g(a,b,c){if(b.indexOf(":")>-1){var d=b.split(":");a.setAttributeNS(t[d[0]],d[1],c)}else"id"===b?a.id=c:a.setAttribute(b,c)}function h(a){var b,c,d;if(a){var e=/[ ,]+/,f=a.match(/translate\((.*)\)/);f&&(b=f[1].split(e));var g=a.match(/rotate\((.*)\)/);g&&(c=g[1].split(e));var h=a.match(/scale\((.*)\)/);h&&(d=h[1].split(e))}var i=d&&d[0]?parseFloat(d[0]):1;return{translate:{tx:b&&b[0]?parseInt(b[0],10):0,ty:b&&b[1]?parseInt(b[1],10):0},rotate:{angle:c&&c[0]?parseInt(c[0],10):0,cx:c&&c[1]?parseInt(c[1],10):void 0,cy:c&&c[2]?parseInt(c[2],10):void 0},scale:{sx:i,sy:d&&d[1]?parseFloat(d[1]):i}}}function i(a,b){var c=b.x*a.a+b.y*a.c+0,d=b.x*a.b+b.y*a.d+0;return{x:c,y:d}}function j(a){var b=i(a,{x:0,y:1}),c=i(a,{x:1,y:0}),d=180/Math.PI*Math.atan2(b.y,b.x)-90,e=180/Math.PI*Math.atan2(c.y,c.x);return{translateX:a.e,translateY:a.f,scaleX:Math.sqrt(a.a*a.a+a.b*a.b),scaleY:Math.sqrt(a.c*a.c+a.d*a.d),skewX:d,skewY:e,rotation:d}}function k(a){a instanceof k&&(a=a.node),this.node=a,this.node.id||(this.node.id=b())}function l(a){a=f(a);var b=["M",a.attr("x1"),a.attr("y1"),"L",a.attr("x2"),a.attr("y2")].join(" ");return b}function m(a){a=f(a);for(var b,c=a.node.points,d=[],e=0;e<c.length;e++)b=c[e],d.push(0===e?"M":"L",b.x,b.y);return d.push("Z"),d.join(" ")}function n(a){a=f(a);for(var b,c=a.node.points,d=[],e=0;e<c.length;e++)b=c[e],d.push(0===e?"M":"L",b.x,b.y);return d.join(" ")}function o(a){a=f(a);var b=parseFloat(a.attr("cx"))||0,c=parseFloat(a.attr("cy"))||0,d=parseFloat(a.attr("r")),e=d*w,g=["M",b,c-d,"C",b+e,c-d,b+d,c-e,b+d,c,"C",b+d,c+e,b+e,c+d,b,c+d,"C",b-e,c+d,b-d,c+e,b-d,c,"C",b-d,c-e,b-e,c-d,b,c-d,"Z"].join(" ");return g}function p(a){a=f(a);var b=parseFloat(a.attr("cx"))||0,c=parseFloat(a.attr("cy"))||0,d=parseFloat(a.attr("rx")),e=parseFloat(a.attr("ry"))||d,g=d*w,h=e*w,i=["M",b,c-e,"C",b+g,c-e,b+d,c-h,b+d,c,"C",b+d,c+h,b+g,c+e,b,c+e,"C",b-g,c+e,b-d,c+h,b-d,c,"C",b-d,c-h,b-g,c-e,b,c-e,"Z"].join(" ");return i}function q(b){b=f(b);var c,d=parseFloat(b.attr("x"))||0,e=parseFloat(b.attr("y"))||0,g=parseFloat(b.attr("width"))||0,h=parseFloat(b.attr("height"))||0,i=parseFloat(b.attr("rx"))||0,j=parseFloat(b.attr("ry"))||0,k=a.rect(d,e,g,h);if(i||j){var l=d+g,m=e+h;c=["M",d+i,e,"L",l-i,e,"Q",l,e,l,e+j,"L",l,e+h-j,"Q",l,m,l-i,m,"L",d+i,m,"Q",d,m,d,m-i,"L",d,e+j,"Q",d,e,d+i,e,"Z"].join(" ")}else c=["M",k.origin().x,k.origin().y,"H",k.corner().x,"V",k.corner().y,"H",k.origin().x,"V",k.origin().y,"Z"].join(" ");return c}function r(a){var b=a.rx||a["top-rx"]||0,c=a.rx||a["bottom-rx"]||0,d=a.ry||a["top-ry"]||0,e=a.ry||a["bottom-ry"]||0;return["M",a.x,a.y+d,"v",a.height-d-e,"a",c,e,0,0,0,c,e,"h",a.width-2*c,"a",c,e,0,0,0,c,-e,"v",-(a.height-e-d),"a",b,d,0,0,0,-b,-d,"h",-(a.width-2*b),"a",b,d,0,0,0,-b,d].join(" ")}var s="object"==typeof window&&!(!window.SVGAngle&&!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1"));if(!s)return function(){};var t={xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink"},u="1.1",v=0;k.prototype={translate:function(a,b,c){c=c||{},b=b||0;var d=this.attr("transform")||"",e=h(d);if("undefined"==typeof a)return e.translate;d=d.replace(/translate\([^\)]*\)/g,"").trim();var f=c.absolute?a:e.translate.tx+a,g=c.absolute?b:e.translate.ty+b,i="translate("+f+","+g+")";return this.attr("transform",(i+" "+d).trim()),this},rotate:function(a,b,c,d){d=d||{};var e=this.attr("transform")||"",f=h(e);if("undefined"==typeof a)return f.rotate;e=e.replace(/rotate\([^\)]*\)/g,"").trim(),a%=360;var g=d.absolute?a:f.rotate.angle+a,i=void 0!==b&&void 0!==c?","+b+","+c:"",j="rotate("+g+i+")";return this.attr("transform",(e+" "+j).trim()),this},scale:function(a,b){b="undefined"==typeof b?a:b;var c=this.attr("transform")||"",d=h(c);if("undefined"==typeof a)return d.scale;c=c.replace(/scale\([^\)]*\)/g,"").trim();var e="scale("+a+","+b+")";return this.attr("transform",(c+" "+e).trim()),this},bbox:function(a,b){if(!this.node.ownerSVGElement)return{x:0,y:0,width:0,height:0};var c;try{c=this.node.getBBox(),c={x:0|c.x,y:0|c.y,width:0|c.width,height:0|c.height}}catch(d){c={x:this.node.clientLeft,y:this.node.clientTop,width:this.node.clientWidth,height:this.node.clientHeight}}if(a)return c;var e=this.node.getTransformToElement(b||this.node.ownerSVGElement);return x.transformRect(c,e)},text:function(a,b){b=b||{};var e,g=a.split("\n"),h=0,i=this.attr("y");i||this.attr("y","0.8em"),this.attr("display",a?null:"none"),this.node.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:space","preserve"),this.node.textContent="";var j=this.node;if(b.textPath){var k=this.find("defs");0===k.length&&(k=f("defs"),this.append(k));var l=Object(b.textPath)===b.textPath?b.textPath.d:b.textPath;if(l){var m=f("path",{d:l});k.append(m)}var n=f("textPath");!b.textPath["xlink:href"]&&m&&n.attr("xlink:href","#"+m.node.id),Object(b.textPath)===b.textPath&&n.attr(b.textPath),this.append(n),j=n.node}for(var o=0,h=0;h<g.length;h++){var p=g[h],q=b.lineHeight||"1em";"auto"===b.lineHeight&&(q="1.5em");var r=x("tspan",{dy:0==h?"0em":q,x:this.attr("x")||0});if(r.addClass("v-line"),p)if(b.annotations){for(var s=0,t=x.annotateString(g[h],d(b.annotations)?b.annotations:[b.annotations],{offset:-o,includeAnnotationIndices:b.includeAnnotationIndices}),u=0;u<t.length;u++){var v=t[u];if(c(v)){var w=parseInt(v.attrs["font-size"],10);w&&w>s&&(s=w),e=x("tspan",v.attrs),b.includeAnnotationIndices&&e.attr("annotations",v.annotations),v.attrs["class"]&&e.addClass(v.attrs["class"]),e.node.textContent=v.t}else e=document.createTextNode(v||" ");r.append(e)}"auto"===b.lineHeight&&s&&0!==h&&r.attr("dy",1.2*s+"px")}else r.node.textContent=p;else r.addClass("v-empty-line"),r.node.textContent=" ";x(j).append(r),o+=p.length+1}return this},attr:function(a,b){if("undefined"==typeof a){for(var c=this.node.attributes,d={},e=0;e<c.length;e++)d[c[e].nodeName]=c[e].nodeValue;return d}if("string"==typeof a&&"undefined"==typeof b)return this.node.getAttribute(a);if("object"==typeof a)for(var f in a)a.hasOwnProperty(f)&&g(this.node,f,a[f]);else g(this.node,a,b);return this},remove:function(){this.node.parentNode&&this.node.parentNode.removeChild(this.node)},append:function(a){var b=a;"[object Array]"!==Object.prototype.toString.call(a)&&(b=[a]);for(var c=0,d=b.length;d>c;c++)a=b[c],this.node.appendChild(a instanceof k?a.node:a);return this},prepend:function(a){this.node.insertBefore(a instanceof k?a.node:a,this.node.firstChild)},svg:function(){return this.node instanceof window.SVGSVGElement?this:x(this.node.ownerSVGElement)},defs:function(){var a=this.svg().node.getElementsByTagName("defs");return a&&a.length?x(a[0]):void 0},clone:function(){var a=x(this.node.cloneNode(!0));return a.node.id=b(),a},findOne:function(a){var b=this.node.querySelector(a);return b?x(b):void 0},find:function(a){for(var b=this.node.querySelectorAll(a),c=0,d=b.length;d>c;c++)b[c]=x(b[c]);return b},index:function(){for(var a=0,b=this.node.previousSibling;b;)1===b.nodeType&&a++,b=b.previousSibling;return a},findParentByClass:function(a,b){b=b||this.node.ownerSVGElement;for(var c=this.node.parentNode;c&&c!==b;){if(x(c).hasClass(a))return x(c);c=c.parentNode}return null},toLocalPoint:function(a,b){var c=this.svg().node,d=c.createSVGPoint();d.x=a,d.y=b;try{var e=d.matrixTransform(c.getScreenCTM().inverse()),f=this.node.getTransformToElement(c).inverse()}catch(g){return d}return e.matrixTransform(f)},translateCenterToPoint:function(b){var c=this.bbox(),d=a.rect(c).center();this.translate(b.x-d.x,b.y-d.y)},translateAndAutoOrient:function(b,c,d){var e=this.scale();this.attr("transform",""),this.scale(e.sx,e.sy);var f=this.svg().node,g=this.bbox(!1,d),h=f.createSVGTransform();h.setTranslate(-g.x-g.width/2,-g.y-g.height/2);var i=f.createSVGTransform(),k=a.point(b).changeInAngle(b.x-c.x,b.y-c.y,c);i.setRotate(k,0,0);var l=f.createSVGTransform(),m=a.point(b).move(c,g.width/2);l.setTranslate(b.x+(b.x-m.x),b.y+(b.y-m.y));var n=this.node.getTransformToElement(d),o=f.createSVGTransform();o.setMatrix(l.matrix.multiply(i.matrix.multiply(h.matrix.multiply(n))));var p=j(o.matrix);return this.translate(p.translateX,p.translateY),this.rotate(p.rotation),this},animateAlongPath:function(a,b){var c=x("animateMotion",a),d=x("mpath",{"xlink:href":"#"+x(b).node.id});c.append(d),this.append(c);try{c.node.beginElement()}catch(e){if("fake"===document.documentElement.getAttribute("smiling")){var f=c.node;f.animators=[];var g=f.getAttribute("id");g&&(id2anim[g]=f);for(var h=getTargets(f),i=0,j=h.length;j>i;i++){var k=h[i],l=new Animator(f,k,i);animators.push(l),f.animators[i]=l,l.register()}}}},hasClass:function(a){return new RegExp("(\\s|^)"+a+"(\\s|$)").test(this.node.getAttribute("class"))},addClass:function(a){if(!this.hasClass(a)){var b=this.node.getAttribute("class")||"";this.node.setAttribute("class",(b+" "+a).trim())}return this},removeClass:function(a){if(this.hasClass(a)){var b=this.node.getAttribute("class").replace(new RegExp("(\\s|^)"+a+"(\\s|$)","g"),"$2");this.node.setAttribute("class",b)}return this},toggleClass:function(a,b){var c="undefined"==typeof b?this.hasClass(a):!b;return c?this.removeClass(a):this.addClass(a),this},sample:function(a){a=a||1;for(var b,c=this.node,d=c.getTotalLength(),e=[],f=0;d>f;)b=c.getPointAtLength(f),e.push({x:b.x,y:b.y,distance:f}),f+=a;return e},convertToPath:function(){var a=f("path");a.attr(this.attr());var b=this.convertToPathData();return b&&a.attr("d",b),a},convertToPathData:function(){var a=this.node.tagName.toUpperCase();switch(a){case"PATH":return this.attr("d");case"LINE":return l(this.node);case"POLYGON":return m(this.node);case"POLYLINE":return n(this.node);case"ELLIPSE":return p(this.node);case"CIRCLE":return o(this.node);case"RECT":return q(this.node)}throw new Error(a+" cannot be converted to PATH.")},findIntersection:function(b,c){var d=this.svg().node;c=c||d;var e=a.rect(this.bbox(!1,c)),f=e.center(),g=e.intersectionWithLineFromCenterToPoint(b);if(!g)return void 0;var h=this.node.localName.toUpperCase();if("RECT"===h){var i=a.rect(parseFloat(this.attr("x")||0),parseFloat(this.attr("y")||0),parseFloat(this.attr("width")),parseFloat(this.attr("height"))),j=this.node.getTransformToElement(c),k=x.decomposeMatrix(j),l=d.createSVGTransform();l.setRotate(-k.rotation,f.x,f.y);var m=x.transformRect(i,l.matrix.multiply(j));g=a.rect(m).intersectionWithLineFromCenterToPoint(b,k.rotation)}else if("PATH"===h||"POLYGON"===h||"POLYLINE"===h||"CIRCLE"===h||"ELLIPSE"===h){for(var n="PATH"===h?this:this.convertToPath(),o=n.sample(),p=1/0,q=[],r=0,s=o.length;s>r;r++){var t=o[r],u=x.createSVGPoint(t.x,t.y);u=u.matrixTransform(this.node.getTransformToElement(c)),t=a.point(u);var v=t.distance(f),w=1.1*t.distance(b),y=v+w;p>y?(p=y,q=[{sample:t,refDistance:w}]):p+1>y&&q.push({sample:t,refDistance:w})}q.sort(function(a,b){return a.refDistance-b.refDistance}),g=q[0].sample}return g}};var w=.5522847498307935,x=f;x.isVElement=function(a){return a instanceof k},x.decomposeMatrix=j,x.rectToPath=r;var y=x("svg").node;return x.createSVGMatrix=function(a){var b=y.createSVGMatrix();for(var c in a)b[c]=a[c];return b},x.createSVGTransform=function(){return y.createSVGTransform()},x.createSVGPoint=function(a,b){var c=y.createSVGPoint();return c.x=a,c.y=b,c},x.transformRect=function(a,b){var c=y.createSVGPoint();c.x=a.x,c.y=a.y;var d=c.matrixTransform(b);c.x=a.x+a.width,c.y=a.y;var e=c.matrixTransform(b);c.x=a.x+a.width,c.y=a.y+a.height;var f=c.matrixTransform(b);c.x=a.x,c.y=a.y+a.height;var g=c.matrixTransform(b),h=Math.min(d.x,e.x,f.x,g.x),i=Math.max(d.x,e.x,f.x,g.x),j=Math.min(d.y,e.y,f.y,g.y),k=Math.max(d.y,e.y,f.y,g.y);return{x:h,y:j,width:i-h,height:k-j}},x.styleToObject=function(a){for(var b={},c=a.split(";"),d=0;d<c.length;d++){var e=c[d],f=e.split("=");b[f[0].trim()]=f[1].trim()}return b},x.createSlicePathData=function(a,b,c,d){var e=2*Math.PI-1e-6,f=a,g=b,h=c,i=d,j=(h>i&&(j=h,h=i,i=j),i-h),k=j<Math.PI?"0":"1",l=Math.cos(h),m=Math.sin(h),n=Math.cos(i),o=Math.sin(i);return j>=e?f?"M0,"+g+"A"+g+","+g+" 0 1,1 0,"+-g+"A"+g+","+g+" 0 1,1 0,"+g+"M0,"+f+"A"+f+","+f+" 0 1,0 0,"+-f+"A"+f+","+f+" 0 1,0 0,"+f+"Z":"M0,"+g+"A"+g+","+g+" 0 1,1 0,"+-g+"A"+g+","+g+" 0 1,1 0,"+g+"Z":f?"M"+g*l+","+g*m+"A"+g+","+g+" 0 "+k+",1 "+g*n+","+g*o+"L"+f*n+","+f*o+"A"+f+","+f+" 0 "+k+",0 "+f*l+","+f*m+"Z":"M"+g*l+","+g*m+"A"+g+","+g+" 0 "+k+",1 "+g*n+","+g*o+"L0,0Z"},x.mergeAttrs=function(a,b){for(var d in b)"class"===d?a[d]=a[d]?a[d]+" "+b[d]:b[d]:"style"===d?c(a[d])&&c(b[d])?a[d]=x.mergeAttrs(a[d],b[d]):c(a[d])?a[d]=x.mergeAttrs(a[d],x.styleToObject(b[d])):c(b[d])?a[d]=x.mergeAttrs(x.styleToObject(a[d]),b[d]):a[d]=x.mergeAttrs(x.styleToObject(a[d]),x.styleToObject(b[d])):a[d]=b[d];return a},x.annotateString=function(a,b,d){b=b||[],d=d||{},offset=d.offset||0;for(var e,f,g,h=[],i=[],j=0;j<a.length;j++){f=i[j]=a[j];for(var k=0;k<b.length;k++){var l=b[k],m=l.start+offset,n=l.end+offset;j>=m&&n>j&&(c(f)?f.attrs=x.mergeAttrs(x.mergeAttrs({},f.attrs),l.attrs):f=i[j]={t:a[j],attrs:l.attrs},d.includeAnnotationIndices&&(f.annotations||(f.annotations=[])).push(k))}g=i[j-1],g?c(f)&&c(g)?JSON.stringify(f.attrs)===JSON.stringify(g.attrs)?e.t+=f.t:(h.push(e),e=f):c(f)?(h.push(e),e=f):c(g)?(h.push(e),e=f):e=(e||"")+f:e=f}return e&&h.push(e),h},x.findAnnotationsAtIndex=function(a,b){if(!a)return[];var c=[];return a.forEach(function(a){a.start<b&&b<=a.end&&c.push(a)}),c},x.findAnnotationsBetweenIndexes=function(a,b,c){if(!a)return[];var d=[];return a.forEach(function(a){(b>=a.start&&b<a.end||c>a.start&&c<=a.end||a.start>=b&&a.end<c)&&d.push(a)}),d},x.shiftAnnotations=function(a,b,c){return a?(a.forEach(function(a){a.start>=b&&(a.start+=c,a.end+=c)}),a):a},x});